<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <script>
        // --- YANGI: foydalanuvchiga xos key yaratish funksiyasi ---
function makeUserKey(baseKey, wallet) {
  return wallet ? baseKey + "_" + wallet.toLowerCase() : baseKey + "_guest";
}

// --- YANGILANGAN loadState() ---
function loadState() {
  const wallet = localStorage.getItem(KEY_WALLET) || "";
  const keyPRC = makeUserKey(KEY_PRC, wallet);
  const keyDiamond = makeUserKey(KEY_DIAMOND, wallet);
  const keyTaps = makeUserKey(KEY_TAPS_USED, wallet);
  const keyCap = makeUserKey(KEY_TAP_CAP, wallet);
  const keySkin = makeUserKey(KEY_SELECTED_SKIN, wallet);

  const prc = localStorage.getItem(keyPRC) || "3700";
  const diamond = parseInt(localStorage.getItem(keyDiamond) || "0", 10);
  const tapsUsed = parseInt(localStorage.getItem(keyTaps) || "0", 10);
  const tapCap = parseInt(localStorage.getItem(keyCap) || String(DEFAULT_TAP_CAP), 10);
  const selectedSkin = localStorage.getItem(keySkin) || "";
  return { prcWei: BigInt(prc), diamond, wallet, tapsUsed, tapCap, selectedSkin };
}

// --- YANGILANGAN saveState() ---
function saveState(state) {
  const wallet = state.wallet || localStorage.getItem(KEY_WALLET) || "";
  const keyPRC = makeUserKey(KEY_PRC, wallet);
  const keyDiamond = makeUserKey(KEY_DIAMOND, wallet);
  const keyTaps = makeUserKey(KEY_TAPS_USED, wallet);
  const keyCap = makeUserKey(KEY_TAP_CAP, wallet);
  const keySkin = makeUserKey(KEY_SELECTED_SKIN, wallet);

  localStorage.setItem(keyPRC, state.prcWei.toString());
  localStorage.setItem(keyDiamond, String(state.diamond));
  localStorage.setItem(keyTaps, String(state.tapsUsed));
  localStorage.setItem(keyCap, String(state.tapCap));
  if (state.selectedSkin)
    localStorage.setItem(keySkin, state.selectedSkin);
  else localStorage.removeItem(keySkin);

  if (state.wallet)
    localStorage.setItem(KEY_WALLET, state.wallet);

  const total = getTotalPRCWei(state);
  const header = document.getElementById('headerBalance');
  if (header) header.textContent = "ðŸ’° PRC balans: " + fmtPRC(total);
}
    </script>
</body>
</html>