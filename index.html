<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ProgUzmiR</title>
  <style>
    /* --- FIX: global non-select and image rules must NOT be nested inside body --- */
    *,
    *::before,
    *::after {
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }

    img {
      pointer-events: none;
      user-select: none;
      -webkit-user-drag: none;
      -webkit-touch-callout: none;
      -webkit-user-drag: none;
    }



    /* body styles */
    body {
      /* rasm markazda, qaytarilmasin, to'liq ekranni qoplasin */
      background-image: url('image/background1.jpg');
      background-position: center center;
      background-repeat: no-repeat;
      background-size: cover;
      background-attachment: fixed;
      /* desktop uchun; mobilda brauzer cheklashi mumkin */
      background-color: #06121a;
      /* rasm yuklanmasa fallback rang */
      color: white;
      text-align: center;
      font-family: sans-serif;
      min-height: 100vh;
      margin: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      box-sizing: border-box;
    }

    h1 {
      margin-bottom: 10px;
    }

    /* NAV: hozir pastda paydo bo'ladi (fixed) */
    .nav {
      display: flex;
      gap: 8px;
      margin-bottom: 5px;
      /* flex-wrap: wrap; */
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.35);
      padding: 8px;
      border-radius: 12px;
      z-index: 60;
    }

    .tab {
      background: rgba(255, 255, 255, 0.08);
      border-radius: 8px;
      padding: 8px 12px;
      cursor: pointer;
      user-select: none;
      color: #fff;
      font-weight: 600;
    }

    .tab.active {
      background: rgba(255, 255, 255, 0.16);
    }

    /* RESPONSIVE LAYOUT */
    :root {
      --header-height: 64px;
    }

    .header {
      position: fixed;
      top: 5px;
      height: var(--header-height);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(0, 0, 0, 0.5);
      padding: 6px 12px;
      border-radius: 10px;
      z-index: 90;
      box-sizing: border-box;
    }

    .header img {
      width: 70px;
      margin-left: -18px;
      height: auto;
      border-radius: 6px;
      display: block;
    }

    .header .balance {
      display: flex;
      font-weight: 700;
      color: #fff;
      text-align: right;
      font-size: 19px;
      align-items: center;
    }

    /* panel: yuqoridagi header uchun joy qoldirish va pastdagi nav uchun safe-area */
    .panel {
      max-width: 420px;
      width: 100%;
      text-align: left;
      padding-top: calc(var(--header-height) + 12px);
      padding-bottom: calc(100px + env(safe-area-inset-bottom));
      box-sizing: border-box;
    }

    /* tap-area va rasm responsivligi */
    .tap-area {
      text-align: center;
      margin-top: 6px;
    }

    #tapBtn {
      width: 100%;
      max-width: 320px;
      height: auto;
      touch-action: manipulation;
      margin-top: -20px;
      pointer-events: painted;
    }

    #tabShop,
    #tabSkins {
      width: 150px;
      height: 40px;
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #tabShop:hover,
    #tabSkins:hover {
      background: rgba(91, 89, 89, 0.5);
      border-radius: 10px;
    }

    .btn-group {
      display: flex;
      border-radius: 10px;
      background: rgba(0, 0, 0, 0.5);
      border-block: 1px solid #fff;
    }

    button.btn {
      color: #fff;
      padding: 10px 10px 10px 10px;
      background: rgba(8, 96, 211, 0.21);
      border-radius: 10px;
    }


    /* nav safe-area */
    .nav {
      bottom: calc(20px + env(safe-area-inset-bottom));
    }

    /* Media queries: telefonlar va planshetlar */
    @media (max-width: 480px) {
      :root {
        --header-height: 56px;
      }

      .nav {
        gap: 1px;
      }

      .header {
        background: rgba(0, 0, 0, 0.5);
        /* xohlasangiz shaffoflikni o'zgartiring */
        padding: 6px 12px;
        width: 97%;
      }

      .header img {
        width: 70px;
        margin-left: -18px;
      }

      .header .balance {
        font-size: 15px;
      }

      .panel {
        padding-top: calc(var(--header-height) + 8px);
        padding-bottom: calc(84px + env(safe-area-inset-bottom));
      }

      #tapBtn {
        max-width: 280px;
      }

      button.btn,
      .input {
        font-size: 15px;
        padding: 12px;
      }

      .btn.buyShopBtn {
        margin-left: 30px;
      }
    }

    @media (min-width:481px) and (max-width:1024px) {
      :root {
        --header-height: 60px;
      }

      .header img {
        width: 70px;
        margin-left: -18px;
      }



      #tapBtn {
        max-width: 240px;
      }


      /* eski #topLogo qoidasi o'rnini yangi header style oladi */
      /* header: full-width style — logo chap, balans oʻngda, orasida ochiq joy */
      .header {
        position: fixed;
        top: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        background: rgba(0, 0, 0, 0.5);
        /* xohlasangiz shaffoflikni o'zgartiring */
        padding: 6px 12px;
        width: 90%;
        border-radius: 10px;
        z-index: 90;
        box-sizing: border-box;
      }

      .header img {
        width: 90px;
        height: auto;
        border-radius: 6px;
        display: block;
      }

      .header .balance {
        font-weight: 700;
        font-size: 18px;
        color: #fff;
        text-align: right;
        align-items: center;
      }
    }

    /* Loading overlay: shows only the image that sharpens over time */
    .loading-overlay {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgb(0, 0, 0);
      z-index: 10000;
      transition: opacity 300ms ease;
    }

    .loading-overlay.hidden {
      opacity: 0;
      pointer-events: none;
      visibility: hidden;
    }

    .loading-img {
      width: 220px;
      max-width: 70%;
      /* filter: blur(12px); */
      opacity: 0.65;
      transition: filter 700ms ease, opacity 400ms ease, transform 700ms ease;
      transform: scale(1.02);
      /* border-radius: 10px; */
      /* box-shadow: 0 8px 40px rgba(0, 0, 0, 0.6); */
    }

    .loading-img.sharp {
      filter: blur(0);
      opacity: 1;
      transform: scale(1);
    }
  </style>
</head>

<body>
  <!-- o'zgardi: endi header container (logo chapda, balans oʻngda) -->
  <div class="header" aria-hidden="false">
    <img src="./image/logo.png" alt="logo" />
    <div class="balance" id="headerBalance"><img src="./image/coin.png" margin-right: 10px; alt="logo" />
      0.000000000000000000 PRC</div>
  </div>

  <!-- panel qoladi yuqorida, nav vizual pastda owing to fixed CSS -->
  <div class="panel" id="content">
    <!-- bo'limlar JavaScript orqali yuklanadi -->
  </div>

  <div class="nav" role="tablist" aria-label="Navigation">
    <div class="tab active" data-tab="game">Game</div>
    <div class="tab" data-tab="rank">Rank</div>
    <div class="tab" data-tab="wallet">WALLET</div>
    <div class="tab" data-tab="market">Market</div>
    <div class="tab" data-tab="earn">Earn</div>
  </div>

  <!-- Loading overlay (shows on app start) -->
  <div id="loadingOverlay" class="loading-overlay">
    <img id="loadingImg" class="loading-img" src="./loading.svg" alt="loading">
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    const tg = window.Telegram && window.Telegram.WebApp;
    if (tg) tg.expand();

    // BigInt birlik: 18 onlik (wei)
    const DECIMALS = 18n;
    const UNIT = 10n ** DECIMALS;

    // Konstantalar (BigInt wei da)
    const BASE_WEI = 1000n; // 0.000000000000001000 PRC -> 1e-15 / 1e-18 = 1000 wei
    const DIAMOND_TO_WEI = 1n; // 1 diamond = 0.000000000000000001 PRC = 1 wei

    const RANKS = ["bronze", "silver", "gold", "smart gold", "platinium", "master"];

    // Local storage keys (yangi fields: tapsUsed, tapCap)
    const KEY_PRC = "proguzmir_prc_wei";
    const KEY_DIAMOND = "proguzmir_diamond";
    const KEY_WALLET = "proguzmir_wallet";
    const KEY_TAPS_USED = "proguzmir_taps_used";
    const KEY_TAP_CAP = "proguzmir_tap_cap";
    const KEY_SELECTED_SKIN = "proguzmir_selected_skin";
    const KEY_ENERGY = "proguzmir_energy";
    const KEY_MAX_ENERGY = "proguzmir_max_energy";
    const DEFAULT_MAX_ENERGY = 1000;

    // Default tap cap va blok o'lchami
    const DEFAULT_TAP_CAP = 1000;
    const INCREASE_BLOCK = 1000; // qancha tapped limitni oshiramiz har xaridda

    // Skinlar ro'yxati
    const SKIN_COST_WEI = 500000000000000n; // 0.0005 PRC = 5e14 wei
    const SKINS = [
      { id: "bronza.png", name: "Bronza", file: "./image/bronza.png" },
      { id: "silver.png", name: "Silver", file: "./image/silver.png" },
      { id: "gold.png", name: "Gold", file: "./image/gold.png" },
      { id: "smart_gold.png", name: "Smart Gold", file: "./image/smart_gold.png" },
      { id: "platinium.png", name: "Platinium", file: "./image/platinium.png" },
      { id: "master.png", name: "Master", file: "./image/master.png" }
    ];

    // Init state (default PRC = 0.0000000000000037 PRC -> 3700 wei)
    // --- YANGI: foydalanuvchiga xos key yaratish funksiyasi ---
    function makeUserKey(baseKey, wallet) {
      return wallet ? baseKey + "_" + wallet.toLowerCase() : baseKey + "_guest";
    }
    // --- YANGILANGAN loadState() ---
    function loadState() {
      const wallet = localStorage.getItem(KEY_WALLET) || "";
      const keyPRC = makeUserKey(KEY_PRC, wallet);
      const keyDiamond = makeUserKey(KEY_DIAMOND, wallet);
      const keyTaps = makeUserKey(KEY_TAPS_USED, wallet);
      const keyCap = makeUserKey(KEY_TAP_CAP, wallet);
      const keySkin = makeUserKey(KEY_SELECTED_SKIN, wallet);
      const keyEnergy = makeUserKey(KEY_ENERGY, wallet);
      const keyMaxEnergy = makeUserKey(KEY_MAX_ENERGY, wallet);

      const prc = localStorage.getItem(keyPRC) || "0";
      const diamond = parseInt(localStorage.getItem(keyDiamond) || "0", 10);
      const tapsUsed = parseInt(localStorage.getItem(keyTaps) || "0", 10);
      const tapCap = parseInt(localStorage.getItem(keyCap) || String(DEFAULT_TAP_CAP), 10);
      const selectedSkin = localStorage.getItem(keySkin) || "";
      const maxEnergy = parseInt(localStorage.getItem(keyMaxEnergy) || String(DEFAULT_MAX_ENERGY), 10);
      let energy = parseInt(localStorage.getItem(keyEnergy) || String(maxEnergy), 10);
      // clamp energy to maxEnergy to avoid >max on corrupted storage
      if (Number.isNaN(energy)) energy = maxEnergy;
      if (energy > maxEnergy) energy = maxEnergy;

      return { prcWei: BigInt(prc), diamond, wallet, tapsUsed, tapCap, selectedSkin, energy, maxEnergy };
    }
    // yangi helper: jami PRC (sotib olingan prcWei + diamond*conversion)
    function getTotalPRCWei(state) {
      return state.prcWei + BigInt(state.diamond) * DIAMOND_TO_WEI;
    }

    // xaridni to'lash: avval prcWei dan, yetmasa diamondlardan (butun diamond birliklari)
    function chargeCost(state, costWei) {
      const total = getTotalPRCWei(state);
      if (total < costWei) return false;
      // agar prcWei yetarli bo'lsa to'g'ridan-to'g'ri kamaytiramiz
      if (state.prcWei >= costWei) {
        state.prcWei -= costWei;
        saveState(state);
        return true;
      }
      // aks holda prcWei ni bo'shatib, qolganni diamondlardan olamiz
      let remaining = costWei - state.prcWei;
      state.prcWei = 0n;
      // qancha diamond kerak: ceil(remaining / DIAMOND_TO_WEI)
      const diamondsNeeded = Number((remaining + DIAMOND_TO_WEI - 1n) / DIAMOND_TO_WEI);
      // kamaytirish
      state.diamond = Math.max(0, state.diamond - diamondsNeeded);
      // agar overpay bo'lsa (diamond birliklari tufayli), qaytimni prcWei ga qo'shamiz
      const paidByDiamondsWei = BigInt(diamondsNeeded) * DIAMOND_TO_WEI;
      const overpay = paidByDiamondsWei - remaining;
      if (overpay > 0n) state.prcWei += overpay;
      saveState(state);
      return true;
    }

    // --- YANGILANGAN saveState() ---
    function saveState(state) {
      const wallet = state.wallet || localStorage.getItem(KEY_WALLET) || "";
      const keyPRC = makeUserKey(KEY_PRC, wallet);
      const keyDiamond = makeUserKey(KEY_DIAMOND, wallet);
      const keyTaps = makeUserKey(KEY_TAPS_USED, wallet);
      const keyCap = makeUserKey(KEY_TAP_CAP, wallet);
      const keySkin = makeUserKey(KEY_SELECTED_SKIN, wallet);
      const keyEnergy = makeUserKey(KEY_ENERGY, wallet);
      const keyMaxEnergy = makeUserKey(KEY_MAX_ENERGY, wallet);

      localStorage.setItem(keyPRC, state.prcWei.toString());
      localStorage.setItem(keyDiamond, String(state.diamond));
      localStorage.setItem(keyTaps, String(state.tapsUsed));
      localStorage.setItem(keyCap, String(state.tapCap));
      // ensure energy/maxEnergy saved with sensible defaults (avoid writing "undefined")
      const maxE = (typeof state.maxEnergy === 'number' && !Number.isNaN(state.maxEnergy)) ? state.maxEnergy : DEFAULT_MAX_ENERGY;
      const en = (typeof state.energy === 'number' && !Number.isNaN(state.energy)) ? Math.min(state.energy, maxE) : maxE;
      localStorage.setItem(keyEnergy, String(en));
      localStorage.setItem(keyMaxEnergy, String(maxE));
      if (state.selectedSkin)
        localStorage.setItem(keySkin, state.selectedSkin);
      else localStorage.removeItem(keySkin);

      if (state.wallet)
        localStorage.setItem(KEY_WALLET, state.wallet);

      const total = getTotalPRCWei(state);
      const header = document.getElementById('headerBalance');
      if (header) header.innerHTML = '<img src="./image/coin.png" alt="logo" style="width:20px; margin-right: 10px; vertical-align:middle;"> ' + fmtPRC(total);
      const energyEl = document.getElementById('tapsCount');
      if (energyEl && typeof state.energy !== 'undefined') energyEl.textContent = `${state.energy} / ${state.maxEnergy}`;
    }

    // doim 18 onlik ko'rsatadi (full precision)
    function fmtPRC(wei) {
      const negative = wei < 0n;
      if (negative) wei = -wei;
      const whole = (wei / UNIT).toString();
      // frac always padded to DECIMALS (18) digits
      let frac = (wei % UNIT).toString().padStart(Number(DECIMALS), '0');

      // remove trailing zeros (so 0.000010000... -> 0.00001)
      let lastNonZero = -1;
      for (let i = frac.length - 1; i >= 0; i--) {
        if (frac[i] !== '0') { lastNonZero = i; break; }
      }
      if (lastNonZero === -1) {
        // all zeros => show .0
        return (negative ? '-' : '') + whole + '.0 PRC';
      }
      frac = frac.slice(0, lastNonZero + 1);

      // compress runs of the same digit:
      // for any run of the same digit with length >= 3, output "d{n}" (e.g. 0{14}, 2{5})
      function compressFraction(s) {
        let out = '';
        let i = 0;
        while (i < s.length) {
          const ch = s[i];
          let j = i + 1;
          while (j < s.length && s[j] === ch) j++;
          const len = j - i;
          if (len >= 3) {
            out += ch + '{' + len + '}';
          } else {
            out += ch.repeat(len);
          }
          i = j;
        }
        return out;
      }

      const compressedFrac = compressFraction(frac);
      return (negative ? '-' : '') + whole + '.' + compressedFrac + ' PRC';
    }

    function getRankFromWei(wei) {
      if (wei < BASE_WEI) return "bronze";
      for (let i = 1; i < RANKS.length; i++) {
        const thr = BASE_WEI * (3n ** BigInt(i - 1));
        if (wei < thr * 3n) return RANKS[i];
      }
      return "master";
    }

    // rank -> image helper
    function rankImage(rank) {
      const map = {
        "bronze": "./image/bronza.png",
        "silver": "./image/silver.png",
        "gold": "./image/gold.png",
        "smart gold": "./image/smart_gold.png",
        "platinium": "./image/platinium.png",
        "master": "./image/paster.png"
      };
      return map[rank] || "./image/logo.png";
    }

    // UI rendering per tab (Game updated with taps logic)
    const content = document.getElementById('content');
    function renderGame() {
      const s = loadState();
      // update header balance immediately on render
      document.getElementById('headerBalance') && (document.getElementById('headerBalance').innerHTML = '<img src="./image/coin.png" alt="logo" style="width:25px; margin-right: 10px; vertical-align:middle;"> ' + fmtPRC(getTotalPRCWei(s)));
      if (typeof s.maxEnergy !== 'number') s.maxEnergy = DEFAULT_MAX_ENERGY;
      if (typeof s.energy !== 'number') s.energy = s.maxEnergy;

      const rank = getRankFromWei(s.prcWei);
      const defaultTapImg = rankImage(rank);
      const selectedSkin = s.selectedSkin;
      const skinObj = SKINS.find(x => x.id === selectedSkin);
      const displayImg = skinObj ? skinObj.file : defaultTapImg;

      // top quick access: Skin (left), Shop (center), Game (right) — diamond THEN previews THEN tap
      content.innerHTML = `
      <div class="tap-area">
        <div id="diamondTop" style="font-size:25px; margin-bottom:15px;">💎 ${s.diamond} </div>
        <!-- previews row: diamond above, previews here, then tap below -->
        <div id="previewsRow" style="display:flex; justify-content: space-between; align-items: center;">
          
          <div id="shopCardPreview" style="display: flex;  flex-direction: column; cursor:pointer; align-items: center;">
            <img src="./image/shop.png" alt="shop" style="width:52px; height:52px; object-fit:cover; margin-bottom: 10px; border-radius:8px;">
            <div style="flex:1; text-align:left;">
              <div style="font-weight:700;">Shop</div>
            </div>
          </div>
          <div id="gameCardPreview" style="display: flex;  flex-direction: column; cursor:pointer; align-items: center;">
            <img src="./image/game.png" alt="game" style="width:64px; height:64px; object-fit:cover; border-radius:8px;">
            <div style="flex:1; text-align:left;">
              <div style="font-weight:800; font-size:14px;">Play Games</div>
            </div>
          </div>
        </div>
        
        <img id="tapBtn" src="${displayImg}" alt="tap" draggable="false">
      </div>

      <div style="margin-top:14px;">
        <div class="row" style="display:flex; justify-content: space-between; gap:10px; align-items:center;">
          <div id="tapsBox" style="display:flex; align-items:center; gap:8px; background: rgba(0,0,0,0.35); border-radius:10px; padding:6px 12px;">
          ⚡️<span id="tapsCount">${s.energy} / ${s.maxEnergy}</span>
          </div>
          <div id="boostsBox" style="background: rgba(0,0,0,0.35); border-radius:10px; padding:8px 12px; display:flex; gap:8px; align-items:center; cursor:pointer;">
            <span style="font-weight:700;">🚀 boosts</span>
          </div>
        </div>
      </div>
     `;

      // tap handler: use energy (manual only) 
      const tapBtn = document.getElementById('tapBtn');
      tapBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        const state = loadState();
        if (state.energy <= 0) { alert('Energiya tugadi — kuting to‘ldirishni.'); return; }

        state.energy = Math.max(0, state.energy - 1);
        state.diamond += 1;
        saveState(state);

        document.getElementById('diamondTop').textContent = '💎 ' + state.diamond;
        document.getElementById('tapsCount').textContent = `${state.energy} / ${state.maxEnergy}`;
      });

      // quick open handlers (top-left previews) — skin preview now opens shop (skin tab inside shop)
      const skinPreview = document.getElementById('skinCardPreview');
      if (skinPreview) skinPreview.addEventListener('click', (ev) => { ev.stopPropagation(); renderShop(); });

      const shopPreview = document.getElementById('shopCardPreview');
      if (shopPreview) shopPreview.addEventListener('click', (ev) => { ev.stopPropagation(); renderShop(); });
      const gamePreview = document.getElementById('gameCardPreview');
      if (gamePreview) gamePreview.addEventListener('click', (ev) => { ev.stopPropagation(); renderGames(); });

      // energy auto-recharge (existing)
      if (window._energyInterval) { clearInterval(window._energyInterval); window._energyInterval = null; }
      window._energyInterval = setInterval(() => {
        const st = loadState();
        if (st.energy < st.maxEnergy) {
          st.energy = Math.min(st.maxEnergy, st.energy + 1);
          saveState(st);
          const el = document.getElementById('tapsCount');
          if (el) el.textContent = `${st.energy} / ${st.maxEnergy}`;
        } else {
          clearInterval(window._energyInterval); window._energyInterval = null;
        }
      }, 1000);

      // replace modal behavior: clicking boostsBox opens Boosts "page" (renderBoosts)
      const boostsBox = document.getElementById('boostsBox');
      if (boostsBox) {
        boostsBox.addEventListener('click', (ev) => { ev.stopPropagation(); renderBoosts(); });
      }

      // helpers to hide/show bottom nav
      function hideNav() { const nav = document.querySelector('.nav'); if (nav) nav.style.display = 'none'; }
      function showNav() { const nav = document.querySelector('.nav'); if (nav) nav.style.display = ''; }

      // --- NEW: renderBoosts shows dedicated Boosts page (like navigating to a tab) ---
      function renderBoosts() {
        hideNav();
        const s2 = loadState();
        content.innerHTML = `
          <div style="display:flex; align-items:center; gap:8px; margin-bottom:12px;">
            <button id="backFromBoosts" style=" left:12px; top:12px; z-index:1200;">◀</button>
            <div style="flex:1; text-align:center; font-weight:800;">🚀 Boosts</div>
          </div>
          <div style="display:flex; flex-direction:column; gap:12px; margin-top:6px;">
            <div style="background:rgba(255,255,255,0.03); padding:12px; border-radius:12px;">
              <div style="font-weight:800;">Energy Pack</div>
              <div style="color:#ccc; margin-top:6px;">Increase your max energy by +${INCREASE_BLOCK}.</div>
              <div style="margin-top:8px;"><button id="buyTapsBtn" class="btn">Buy +${INCREASE_BLOCK} energy (${fmtPRC(BigInt(INCREASE_BLOCK) * DIAMOND_TO_WEI)})</button></div>
            </div>
          </div>
        `;
        document.getElementById('backFromBoosts').addEventListener('click', () => { showNav(); renderGame(); });
        document.getElementById('buyTapsBtn').addEventListener('click', () => {
          const state = loadState();
          const cost = BigInt(INCREASE_BLOCK) * DIAMOND_TO_WEI;
          if (!chargeCost(state, cost)) { alert('Yetarli PRC yo‘q.'); return; }
          state.maxEnergy = (state.maxEnergy || DEFAULT_MAX_ENERGY) + INCREASE_BLOCK;
          saveState(state);
          alert(`Sotib olindi: +${INCREASE_BLOCK} energy limit. Yangi max energy: ${state.maxEnergy}`);
          renderBoosts();
        });
      }

      // --- NEW: renderShop (card layout) ---
      const SHOP_ITEMS = [
        { id: 'energyPack', name: 'Energy +1000', img: './image/boost.png', type: 'energy', amount: INCREASE_BLOCK, costWei: BigInt(INCREASE_BLOCK) * DIAMOND_TO_WEI },
        { id: 'tapPack', name: 'Taps +1000', img: './image/coin.png', type: 'taps', amount: INCREASE_BLOCK, costWei: BigInt(INCREASE_BLOCK) * DIAMOND_TO_WEI }
      ];
      function renderShop() {
        hideNav();
        const s = loadState();
        // header with back and internal tabs
        content.innerHTML = `
          <div style="display:flex; align-items:center; gap:8px; margin-bottom:12px;">
            <button id="backFromShop" class="btn">◀</button>
            <div class="btn-group">
              <div id="tabShop" class="btn">Shop</div>
              <div id="tabSkins" class="btn">Skins</div>
            </div>
          </div>
          <div style="display:flex; gap:12px; margin-top:6px;">
            <div id="shopCol" style="flex:1; display:flex; flex-direction:column; gap:12px;">
              ${SHOP_ITEMS.map(it => `
                <div class="shop-item" data-id="${it.id}" style=" margin-bottom: 20px; display: flex; background:rgba(0,0,0,0.5); border-radius:12px; padding:12px;">
                  <img src="${it.img}" alt="${it.name}" style="width:100px; object-fit:cover; border-radius:8px;">
                  <div style="margin-top:8px; display:flex; justify-content:space-between; align-items:center;">
                    <div><b>${it.name}</b><div style="color:#ccc; font-size:13px;">Cost: ${fmtPRC(it.costWei)}</div></div>
                    <button class="btn buyShopBtn" data-id="${it.id}">Buy</button>
                  </div>
                </div>
              `).join('')}
            </div>
            <div id="skinCol" style="flex:1; display:flex; flex-direction:column; gap:12px; display:none;">
              ${SKINS.map(sk => `
                <div class="skin-item" data-skin="${sk.id}" style="    margin-bottom: 20px; background:rgba(0,0,0,0.5); border-radius:12px; padding:12px;">
                  <img src="./image/${sk.id}" alt="${sk.name}" style="width:200px;  object-fit:cover; border-radius:8px;">
                  <div style="margin-top:8px; display:flex; justify-content:space-between; align-items:center;">
                    <div><b>${sk.name}</b><div style="color:#ccc; font-size:13px;">Skin for your tap</div></div>
                    <button class="btn buySkinBtn" data-skin="${sk.id}">Buy</button>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
        document.getElementById('backFromShop').addEventListener('click', () => { showNav(); renderGame(); });
        // tab handlers
        const tabShop = document.getElementById('tabShop');
        const tabSkins = document.getElementById('tabSkins');
        const shopCol = document.getElementById('shopCol');
        const skinCol = document.getElementById('skinCol');
        function activateShop() { shopCol.style.display = ''; skinCol.style.display = 'none'; tabShop.disabled = true; tabSkins.disabled = false; }
        function activateSkins() { shopCol.style.display = 'none'; skinCol.style.display = ''; tabShop.disabled = false; tabSkins.disabled = true; }
        tabShop.addEventListener('click', activateShop);
        tabSkins.addEventListener('click', activateSkins);
        // default active
        activateShop();
        // shop buys
        document.querySelectorAll('.buyShopBtn').forEach(btn => {
          btn.addEventListener('click', () => {
            const id = btn.dataset.id;
            const item = SHOP_ITEMS.find(x => x.id === id);
            if (!item) return;
            const state = loadState();
            if (!chargeCost(state, item.costWei)) { alert('Yetarli PRC yo‘q.'); return; }
            if (item.type === 'energy') state.maxEnergy = (state.maxEnergy || DEFAULT_MAX_ENERGY) + item.amount;
            else if (item.type === 'taps') state.tapCap = (state.tapCap || DEFAULT_TAP_CAP) + item.amount;
            saveState(state);
            alert(`${item.name} sotib olindi.`);
            renderShop();
          });
        });
        // skin buys (inside shop)
        document.querySelectorAll('.buySkinBtn').forEach(btn => {
          btn.addEventListener('click', () => {
            const skinId = btn.dataset.skin;
            const state = loadState();
            if (!chargeCost(state, SKIN_COST_WEI)) { alert('Yetarli PRC yo‘q skin sotib olish uchun.'); return; }
            state.selectedSkin = skinId;
            saveState(state);
            alert('Skin sotib olindi: ' + SKINS.find(s => s.id === skinId).name);
            renderShop();
          });
        });
      }

      // --- NEW: renderGames (list of game cards) ---
      const GAMES = [
        { id: 'game1', name: 'Game One', img: './game/game1.png' }
      ];
      function renderGames() {
        hideNav();
        const s = loadState();
        content.innerHTML = `
          <div style="display:flex; align-items:center; gap:8px; margin-bottom:12px;">
            <button id="backFromGames" style=" left:12px; top:12px; z-index:1200;">◀</button>
            <div style="flex:1; text-align:center; font-weight:800;">🎮 Games</div>
          </div>
          <div style="display:flex; justify-content:space-between; gap:12px; margin-top:6px;">
            <div style="flex:1; display:flex; flex-direction:column; gap:12px;">
              ${GAMES.map(g => `
                <div style="background:rgba(255,255,255,0.03); border-radius:12px; padding:12px; display:flex; flex-direction:column; justify-content:space-between; height:160px;">
                  <img src="${g.img}" alt="${g.name}" style="width:100%; height:90px; object-fit:cover; border-radius:8px;">
                  <div style="margin-top:8px; display:flex; justify-content:space-between; align-items:center;">
                    <div><b>${g.name}</b><div style="color:#ccc; font-size:13px;">Tap to play</div></div>
                    <button class="btn playGameBtn" data-id="${g.id}">Play</button>
                  </div>
                </div>
              `).join('')}
            </div>
            <div style="flex:1;"></div>
          </div>
        `;
        document.getElementById('backFromGames').addEventListener('click', () => { showNav(); renderGame(); });
        document.querySelectorAll('.playGameBtn').forEach(btn => {
          btn.addEventListener('click', () => {
            const id = btn.dataset.id;
            alert('Launching ' + id + ' (placeholder)');
            // future: integrate actual mini-game launch
          });
        });
      }
    } // end of function renderGame()

    // Loading helpers: show overlay, animate image from blurred -> sharp, then hide
    function showLoading() {
      const overlay = document.getElementById('loadingOverlay');
      const img = document.getElementById('loadingImg');
      if (!overlay || !img) return;
      overlay.classList.remove('hidden');
      // ensure start state (blurred)
      img.classList.remove('sharp');
      // small delay to allow CSS applied, then sharpen
      requestAnimationFrame(() => {
        setTimeout(() => img.classList.add('sharp'), 60);
      });
    }

    function hideLoading() {
      const overlay = document.getElementById('loadingOverlay');
      const img = document.getElementById('loadingImg');
      if (!overlay) return;
      // reverse visual quickly, then hide overlay after transition
      if (img) img.classList.remove('sharp');
      overlay.classList.add('hidden');
    }

    // Tab switching (nav fixed at bottom visually)
    document.querySelectorAll('.nav .tab').forEach(el => {
      el.addEventListener('click', () => {
        document.querySelectorAll('.nav .tab').forEach(t => t.classList.remove('active'));
        el.classList.add('active');
        const tab = el.dataset.tab;
        if (tab === 'game') renderGame();
        if (tab === 'rank') renderRank();
        if (tab === 'wallet') renderWallet();
        if (tab === 'market') renderMarket();
        if (tab === 'earn') renderEarn();
      });
    });

    // default: show loading first, then render and hide overlay
    showLoading();
    // wait a moment for the sharp animation, then render UI and hide loading
    setTimeout(() => {
      renderGame();
      // allow a bit for render and final visual — then hide overlay
      setTimeout(hideLoading, 350);
    }, 700);

    document.querySelectorAll('img').forEach(img => {
      img.addEventListener('contextmenu', e => e.preventDefault()); // O‘ng bosish menyusini o‘chiradi
    });
    document.addEventListener('contextmenu', event => event.preventDefault());
    document.addEventListener('selectstart', event => event.preventDefault());
    document.addEventListener('contextmenu', e => e.preventDefault());
    document.addEventListener('dragstart', e => e.preventDefault());
    document.addEventListener('touchstart', e => e.preventDefault());
  </script>

</body>

</html>