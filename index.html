<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ProgUzmiR</title>
  <style>
    body {
      * {
        user-select: none;
        -webkit-user-select: none;
        /* iPhone/Android uchun */
        -moz-user-select: none;
        /* Firefox uchun */
        -ms-user-select: none;
        /* Eski IE uchun */
      }

      img {
        pointer-events: none;
        user-select: none;
        -webkit-user-drag: none;
        -webkit-touch-callout: none;
        -webkit-user-drag: none;
        /* Safari, iPhone */
      }



      /* rasm markazda, qaytarilmasin, to'liq ekranni qoplasin */
      background-image: url('image/background1.jpg');
      background-position: center center;
      background-repeat: no-repeat;
      background-size: cover;
      background-attachment: fixed;
      /* desktop uchun; mobilda brauzer cheklashi mumkin */
      background-color: #06121a;
      /* rasm yuklanmasa fallback rang */
      color: white;
      text-align: center;
      font-family: sans-serif;
      min-height: 100vh;
      margin: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      box-sizing: border-box;
    }

    h1 {
      margin-bottom: 10px;
    }

    /* NAV: hozir pastda paydo bo'ladi (fixed) */
    .nav {
      display: flex;
      gap: 8px;
      margin-bottom: 5px;
      /* flex-wrap: wrap; */
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.35);
      padding: 8px;
      border-radius: 12px;
      z-index: 60;
    }

    .tab {
      background: rgba(255, 255, 255, 0.08);
      border-radius: 8px;
      padding: 8px 12px;
      cursor: pointer;
      user-select: none;
      color: #fff;
      font-weight: 600;
    }

    .tab.active {
      background: rgba(255, 255, 255, 0.16);
    }

    /* RESPONSIVE LAYOUT */
    :root {
      --header-height: 64px;
    }

    .header {
      width: 50%;
      position: fixed;
      top: 7px;
      height: var(--header-height);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(0, 0, 0, 0.5);
      padding: 6px 12px;
      border-radius: 15px;
      z-index: 90;
      box-sizing: border-box;
    }

    .header img {
      width: 70px;
      height: auto;
      border-radius: 6px;
      display: block;
    }

    .header .balance {
      display: flex;
      font-weight: 700;
      color: #fff;
      text-align: right;
      font-size: 19px;
      align-items: center;
    }

    /* panel: yuqoridagi header uchun joy qoldirish va pastdagi nav uchun safe-area */
    .panel {
      max-width: 420px;
      width: 100%;
      text-align: left;
      padding-top: calc(var(--header-height) + 12px);
      padding-bottom: calc(100px + env(safe-area-inset-bottom));
      box-sizing: border-box;
    }

    /* tap-area va rasm responsivligi */
    .tap-area {
      text-align: center;
      margin-top: 6px;
    }

    #tapBtn {
      width: 100%;
      max-width: 320px;
      height: auto;
      touch-action: manipulation;
      margin-top: -20px;
      pointer-events: painted;
    }

    #tabShop,
    #tabSkins {
      width: 150px;
      height: 40px;
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #tabShop:hover,
    #tabSkins:hover {
      background: rgba(91, 89, 89, 0.5);
      border-radius: 10px;
    }

    .btn-group {
      display: flex;
      border-radius: 10px;
      background: rgba(0, 0, 0, 0.5);
      border-block: 1px solid #fff;
    }

    button.btn {
      color: #fff;
      padding: 10px 10px 10px 10px;
      background: rgba(8, 96, 211, 0.21);
      border-radius: 10px;
    }


    /* nav safe-area */
    .nav {
      bottom: calc(20px + env(safe-area-inset-bottom));
    }

    /* Media queries: telefonlar va planshetlar */
    @media (max-width: 480px) {
      :root {
        --header-height: 56px;
      }

      .nav {
        gap: 1px;
      }

      .header {
        background: rgba(0, 0, 0, 0.5);
        /* xohlasangiz shaffoflikni o'zgartiring */
        padding: 6px 12px;
        width: 97%;
      }

      .header img {
        width: 70px;
        margin-left: -18px;
      }

      .header .balance {
        font-size: 15px;
      }

      .panel {
        padding-top: calc(var(--header-height) + 8px);
        padding-bottom: calc(84px + env(safe-area-inset-bottom));
      }

      #tapBtn {
        max-width: 280px;
      }

      button.btn,
      .input {
        font-size: 15px;
        padding: 12px;
      }

      .btn.buyShopBtn {
        margin-left: 30px;
      }
    }

    @media (min-width:481px) and (max-width:1024px) {
      :root {
        --header-height: 60px;
      }

      .header img {
        width: 70px;
        margin-left: -18px;
      }



      #tapBtn {
        max-width: 240px;
      }


      /* eski #topLogo qoidasi o'rnini yangi header style oladi */
      /* header: full-width style — logo chap, balans oʻngda, orasida ochiq joy */
      .header {
        position: fixed;
        top: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        background: rgba(0, 0, 0, 0.5);
        /* xohlasangiz shaffoflikni o'zgartiring */
        padding: 6px 12px;
        width: 90%;
        border-radius: 10px;
        z-index: 90;
        box-sizing: border-box;
      }

      .header img {
        width: 90px;
        height: auto;
        border-radius: 6px;
        display: block;
      }

      .header .balance {
        font-weight: 700;
        font-size: 18px;
        color: #fff;
        text-align: right;
        align-items: center;
      }
    }

    /* Loading overlay: shows only the image that sharpens over time */
    .loading-overlay {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgb(0, 0, 0);
      z-index: 10000;
      transition: opacity 300ms ease;
    }

    .loading-overlay.hidden {
      opacity: 0;
      pointer-events: none;
      visibility: hidden;
    }

    .loading-img {
      width: 100px;
      max-width: 70%;
      /* filter: blur(12px); */
      opacity: 0.65;
      transition: filter 700ms ease, opacity 400ms ease, transform 700ms ease;
      transform: scale(1.02);
      /* border-radius: 10px; */
      /* box-shadow: 0 8px 40px rgba(0, 0, 0, 0.6); */
    }

    .loading-img.sharp {
      filter: blur(0);
      opacity: 1;
      transform: scale(1);
    }
  </style>
</head>

<body>
  <!-- o'zgardi: endi header container (logo chapda, balans oʻngda) -->
  <div class="header" aria-hidden="false">
    <svg width="10mm" height="12mm" viewBox="0 0 210 297" xmlns:xlink="http://www.w3.org/1999/xlink"
      xmlns="http://www.w3.org/2000/svg">
      <defs>
        <linearGradient xlink:href="#a" id="b" x1="168.785" y1="69.16" x2="261.584" y2="327.725"
          gradientUnits="userSpaceOnUse" spreadMethod="repeat"
          gradientTransform="translate(-103.266 -61.533)scale(1.06314)" />
        <linearGradient id="a">
          <stop style="stop-color:#ffc50d;stop-opacity:1" offset="0" />
          <stop style="stop-color:#ffc50d;stop-opacity:.96078431" offset=".345" />
          <stop style="stop-color:#ffc50d;stop-opacity:.82352941" offset=".635" />
          <stop style="stop-color:#ffc50d;stop-opacity:.50980392" offset=".979" />
          <stop style="stop-color:#ffc50d;stop-opacity:0" offset="1" />
        </linearGradient>
      </defs>
      <path style="display:inline;fill:url(#b);fill-opacity:1;stroke-width:1.06314"
        d="M201.54 91.005c-63.432 41.022-125.94 80.292-188.402 119.93 15.918 18.902 26.202 30.908 35.027 38.58L40.86 273.73l15.698 4.551 5.553-19.707c1.15.983 1.51 1.191 6.638 3.8 2.862 1.431 6.02 2.036 9.103 2.797l-5.261 18.162 15.866 4.257 5.76-20.727c.536-.008 6.259-.148 14.614-2.278 8.418-2.222 15.966-6.587 23.046-11.522 5.398-3.3 9.694-7.892 13.904-12.525 7.357-8.744 9.795-19.957 10.395-31.064-.783-23.747-18.392-41.119-33.192-57.908l84.233-54.151zm-98.6 73.149c7.088 7.974 14.128 15.98 20.312 24.68 8.128 11.136 7.012 22.052 5.903 26.925-5.392 17.405-26.493 24.68-29.876 25.744-5.653 1.38-11.393 1.175-17.122.708-19.105-5.41-30.951-22.802-43.458-37.08zm20.253-153.875-5.51 20.542c-3.482-.053-6.91.417-10.356.835-8.114 1.622-10.757 2.568-24.884 10.855-5.12 3.348-9.523 7.576-13.777 11.94-7.998 9.394-11.12 20.487-12.275 32.525.905 23.05 18.184 40.502 32.634 56.79l-30.962 20.252-55.447 34.893 5.553 6.263L196.625 84.84c-11.406-12.26-21.211-26.19-33.952-37.167l6.78-23.366-15.53-4.204-4.845 17.732c-1.838-1.053-3.766-1.929-5.677-2.838-3.337-1.157-6.654-2.162-10.187-2.507l4.843-17.87zm-.907 43.916c22.542.993 36.42 21.905 49.482 37.671l-62.944 39.68c-6.638-8.082-13.422-16.044-19.956-24.21-5.479-6.982-7.451-15.511-6.024-24.091 2.43-13.291 14.503-20.779 22.793-25.27 5.208-2.575 10.902-3.435 16.65-3.78" />
    </svg>
    <div class="balance" id="headerBalance"><img src="./image/coin.png" margin-right: 10px; alt="logo" />
      0.000000000000000000 PRC</div>
  </div>

  <!-- panel qoladi yuqorida, nav vizual pastda owing to fixed CSS -->
  <div class="panel" id="content">
    <!-- bo'limlar JavaScript orqali yuklanadi -->
  </div>

  <div class="nav" role="tablist" aria-label="Navigation">
    <div class="tab active" data-tab="game">Game</div>
    <div class="tab" data-tab="rank">Rank</div>
    <div class="tab" data-tab="wallet">WALLET</div>
    <div class="tab" data-tab="market">Market</div>
    <div class="tab" data-tab="earn">Earn</div>
  </div>

  <!-- Loading overlay (shows on app start) -->
  <div id="loadingOverlay" class="loading-overlay hidden" aria-hidden="true" role="status" aria-live="polite">
    <svg id="loadingImg" class="loading-img" viewBox="0 0 210 297" xmlns:xlink="http://www.w3.org/1999/xlink"
      xmlns="http://www.w3.org/2000/svg">
      <defs>
        <linearGradient xlink:href="#a" id="b" x1="168.785" y1="69.16" x2="261.584" y2="327.725"
          gradientUnits="userSpaceOnUse" spreadMethod="repeat"
          gradientTransform="translate(-103.266 -61.533)scale(1.06314)" />
        <linearGradient id="a">
          <stop style="stop-color:#ffc50d;stop-opacity:1" offset="0" />
          <stop style="stop-color:#ffc50d;stop-opacity:.96078431" offset=".345" />
          <stop style="stop-color:#ffc50d;stop-opacity:.82352941" offset=".635" />
          <stop style="stop-color:#ffc50d;stop-opacity:.50980392" offset=".979" />
          <stop style="stop-color:#ffc50d;stop-opacity:0" offset="1" />
        </linearGradient>
      </defs>
      <path style="display:inline;fill:url(#b);fill-opacity:1;stroke-width:1.06314"
        d="M201.54 91.005c-63.432 41.022-125.94 80.292-188.402 119.93 15.918 18.902 26.202 30.908 35.027 38.58L40.86 273.73l15.698 4.551 5.553-19.707c1.15.983 1.51 1.191 6.638 3.8 2.862 1.431 6.02 2.036 9.103 2.797l-5.261 18.162 15.866 4.257 5.76-20.727c.536-.008 6.259-.148 14.614-2.278 8.418-2.222 15.966-6.587 23.046-11.522 5.398-3.3 9.694-7.892 13.904-12.525 7.357-8.744 9.795-19.957 10.395-31.064-.783-23.747-18.392-41.119-33.192-57.908l84.233-54.151zm-98.6 73.149c7.088 7.974 14.128 15.98 20.312 24.68 8.128 11.136 7.012 22.052 5.903 26.925-5.392 17.405-26.493 24.68-29.876 25.744-5.653 1.38-11.393 1.175-17.122.708-19.105-5.41-30.951-22.802-43.458-37.08zm20.253-153.875-5.51 20.542c-3.482-.053-6.91.417-10.356.835-8.114 1.622-10.757 2.568-24.884 10.855-5.12 3.348-9.523 7.576-13.777 11.94-7.998 9.394-11.12 20.487-12.275 32.525.905 23.05 18.184 40.502 32.634 56.79l-30.962 20.252-55.447 34.893 5.553 6.263L196.625 84.84c-11.406-12.26-21.211-26.19-33.952-37.167l6.78-23.366-15.53-4.204-4.845 17.732c-1.838-1.053-3.766-1.929-5.677-2.838-3.337-1.157-6.654-2.162-10.187-2.507l4.843-17.87zm-.907 43.916c22.542.993 36.42 21.905 49.482 37.671l-62.944 39.68c-6.638-8.082-13.422-16.044-19.956-24.21-5.479-6.982-7.451-15.511-6.024-24.091 2.43-13.291 14.503-20.779 22.793-25.27 5.208-2.575 10.902-3.435 16.65-3.78" />
    </svg>
    <div id="loadingText" class="loading-text" style="display:none; color:#fff; font-weight:700; font-size:18px;">
      loading...</div>
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    const tg = window.Telegram && window.Telegram.WebApp;
    if (tg) {
      try { tg.expand(); } catch (e) { }
      try { tg.BackButton.show(); } catch (e) { }
      // BackButton behavior: on main view -> close app; on games view -> go back to main
      tg.BackButton.onClick(() => {
        if (window.currentView === 'games') {
          renderGame();
          window.currentView = 'game';
          // ensure BackButton stays visible for index context
          try { tg.BackButton.show(); } catch (e) { }
        } else {
          // default: close mini app from main view
          try { tg.close(); } catch (e) { }
        }
      });
    }

    // BigInt birlik: 18 onlik (wei)
    const DECIMALS = 18n;
    const UNIT = 10n ** DECIMALS;

    // Konstantalar (BigInt wei da)
    const BASE_WEI = 1000n; // 0.000000000000001000 PRC -> 1e-15 / 1e-18 = 1000 wei
    const DIAMOND_TO_WEI = 1n; // 1 diamond = 0.000000000000000001 PRC = 1 wei

    const RANKS = ["bronze", "silver", "gold", "smart gold", "platinium", "master"];

    // Local storage keys (yangi fields: tapsUsed, tapCap)
    const KEY_PRC = "proguzmir_prc_wei";
    const KEY_DIAMOND = "proguzmir_diamond";
    const KEY_WALLET = "proguzmir_wallet";
    const KEY_TAPS_USED = "proguzmir_taps_used";
    const KEY_TAP_CAP = "proguzmir_tap_cap";
    const KEY_SELECTED_SKIN = "proguzmir_selected_skin";
    const KEY_ENERGY = "proguzmir_energy";
    const KEY_MAX_ENERGY = "proguzmir_max_energy";
    const DEFAULT_MAX_ENERGY = 1000;

    // Default tap cap va blok o'lchami
    const DEFAULT_TAP_CAP = 1000;
    const INCREASE_BLOCK = 1000; // qancha tapped limitni oshiramiz har xaridda

    // Skinlar ro'yxati
    const SKIN_COST_WEI = 500000000000000n; // 0.0005 PRC = 5e14 wei
    const SKINS = [
      { id: "bronza.png", name: "Bronza", file: "./image/bronza.png" },
      { id: "silver.png", name: "Silver", file: "./image/silver.png" },
      { id: "gold.png", name: "Gold", file: "./image/gold.png" },
      { id: "smart_gold.png", name: "Smart Gold", file: "./image/smart_gold.png" },
      { id: "platinium.png", name: "Platinium", file: "./image/platinium.png" },
      { id: "master.png", name: "Master", file: "./image/master.png" }
    ];

    // Init state (default PRC = 0.0000000000000037 PRC -> 3700 wei)
    // --- YANGI: foydalanuvchiga xos key yaratish funksiyasi ---
    function makeUserKey(baseKey, wallet) {
      return wallet ? baseKey + "_" + wallet.toLowerCase() : baseKey + "_guest";
    }
    // --- YANGILANGAN loadState() ---
    function loadState() {
      const wallet = localStorage.getItem(KEY_WALLET) || "";
      const keyPRC = makeUserKey(KEY_PRC, wallet);
      const keyDiamond = makeUserKey(KEY_DIAMOND, wallet);
      const keyTaps = makeUserKey(KEY_TAPS_USED, wallet);
      const keyCap = makeUserKey(KEY_TAP_CAP, wallet);
      const keySkin = makeUserKey(KEY_SELECTED_SKIN, wallet);
      const keyEnergy = makeUserKey(KEY_ENERGY, wallet);
      const keyMaxEnergy = makeUserKey(KEY_MAX_ENERGY, wallet);

      const prc = localStorage.getItem(keyPRC) || "0";
      const diamond = parseInt(localStorage.getItem(keyDiamond) || "0", 10);
      const tapsUsed = parseInt(localStorage.getItem(keyTaps) || "0", 10);
      const tapCap = parseInt(localStorage.getItem(keyCap) || String(DEFAULT_TAP_CAP), 10);
      const selectedSkin = localStorage.getItem(keySkin) || "";
      const maxEnergy = parseInt(localStorage.getItem(keyMaxEnergy) || String(DEFAULT_MAX_ENERGY), 10);
      let energy = parseInt(localStorage.getItem(keyEnergy) || String(maxEnergy), 10);
      // clamp energy to maxEnergy to avoid >max on corrupted storage
      if (Number.isNaN(energy)) energy = maxEnergy;
      if (energy > maxEnergy) energy = maxEnergy;

      return { prcWei: BigInt(prc), diamond, wallet, tapsUsed, tapCap, selectedSkin, energy, maxEnergy };
    }
    // yangi helper: jami PRC (sotib olingan prcWei + diamond*conversion)
    function getTotalPRCWei(state) {
      return state.prcWei + BigInt(state.diamond) * DIAMOND_TO_WEI;
    }

    // xaridni to'lash: avval prcWei dan, yetmasa diamondlardan (butun diamond birliklari)
    function chargeCost(state, costWei) {
      const total = getTotalPRCWei(state);
      if (total < costWei) return false;
      // agar prcWei yetarli bo'lsa to'g'ridan-to'g'ri kamaytiramiz
      if (state.prcWei >= costWei) {
        state.prcWei -= costWei;
        saveState(state);
        return true;
      }
      // aks holda prcWei ni bo'shatib, qolganni diamondlardan olamiz
      let remaining = costWei - state.prcWei;
      state.prcWei = 0n;
      // qancha diamond kerak: ceil(remaining / DIAMOND_TO_WEI)
      const diamondsNeeded = Number((remaining + DIAMOND_TO_WEI - 1n) / DIAMOND_TO_WEI);
      // kamaytirish
      state.diamond = Math.max(0, state.diamond - diamondsNeeded);
      // agar overpay bo'lsa (diamond birliklari tufayli), qaytimni prcWei ga qo'shamiz
      const paidByDiamondsWei = BigInt(diamondsNeeded) * DIAMOND_TO_WEI;
      const overpay = paidByDiamondsWei - remaining;
      if (overpay > 0n) state.prcWei += overpay;
      saveState(state);
      return true;
    }

    // --- YANGILANGAN saveState() ---
    function saveState(state) {
      const wallet = state.wallet || localStorage.getItem(KEY_WALLET) || "";
      const keyPRC = makeUserKey(KEY_PRC, wallet);
      const keyDiamond = makeUserKey(KEY_DIAMOND, wallet);
      const keyTaps = makeUserKey(KEY_TAPS_USED, wallet);
      const keyCap = makeUserKey(KEY_TAP_CAP, wallet);
      const keySkin = makeUserKey(KEY_SELECTED_SKIN, wallet);
      const keyEnergy = makeUserKey(KEY_ENERGY, wallet);
      const keyMaxEnergy = makeUserKey(KEY_MAX_ENERGY, wallet);

      localStorage.setItem(keyPRC, state.prcWei.toString());
      localStorage.setItem(keyDiamond, String(state.diamond));
      localStorage.setItem(keyTaps, String(state.tapsUsed));
      localStorage.setItem(keyCap, String(state.tapCap));
      // ensure energy/maxEnergy saved with sensible defaults (avoid writing "undefined")
      const maxE = (typeof state.maxEnergy === 'number' && !Number.isNaN(state.maxEnergy)) ? state.maxEnergy : DEFAULT_MAX_ENERGY;
      const en = (typeof state.energy === 'number' && !Number.isNaN(state.energy)) ? Math.min(state.energy, maxE) : maxE;
      localStorage.setItem(keyEnergy, String(en));
      localStorage.setItem(keyMaxEnergy, String(maxE));
      if (state.selectedSkin)
        localStorage.setItem(keySkin, state.selectedSkin);
      else localStorage.removeItem(keySkin);

      if (state.wallet)
        localStorage.setItem(KEY_WALLET, state.wallet);

      const total = getTotalPRCWei(state);
      const header = document.getElementById('headerBalance');
      if (header) header.innerHTML = '<img src="./image/coin.png" alt="logo" style="width:20px; margin-right: 10px; vertical-align:middle;"> ' + fmtPRC(total);
      const energyEl = document.getElementById('tapsCount');
      if (energyEl && typeof state.energy !== 'undefined') energyEl.textContent = `${state.energy} / ${state.maxEnergy}`;
    }

    // doim 18 onlik ko'rsatadi (full precision)
    function fmtPRC(wei) {
      const negative = wei < 0n;
      if (negative) wei = -wei;
      const whole = (wei / UNIT).toString();
      // frac always padded to DECIMALS (18) digits
      let frac = (wei % UNIT).toString().padStart(Number(DECIMALS), '0');

      // remove trailing zeros (so 0.000010000... -> 0.00001)
      let lastNonZero = -1;
      for (let i = frac.length - 1; i >= 0; i--) {
        if (frac[i] !== '0') { lastNonZero = i; break; }
      }
      if (lastNonZero === -1) {
        // all zeros => show .0
        return (negative ? '-' : '') + whole + '.0 PRC';
      }
      frac = frac.slice(0, lastNonZero + 1);

      // compress runs of the same digit:
      // for any run of the same digit with length >= 3, output "d{n}" (e.g. 0{14}, 2{5})
      function compressFraction(s) {
        let out = '';
        let i = 0;
        while (i < s.length) {
          const ch = s[i];
          let j = i + 1;
          while (j < s.length && s[j] === ch) j++;
          const len = j - i;
          if (len >= 3) {
            out += ch + '{' + len + '}';
          } else {
            out += ch.repeat(len);
          }
          i = j;
        }
        return out;
      }

      const compressedFrac = compressFraction(frac);
      return (negative ? '-' : '') + whole + '.' + compressedFrac + ' PRC';
    }

    function getRankFromWei(wei) {
      if (wei < BASE_WEI) return "bronze";
      for (let i = 1; i < RANKS.length; i++) {
        const thr = BASE_WEI * (3n ** BigInt(i - 1));
        if (wei < thr * 3n) return RANKS[i];
      }
      return "master";
    }

    // rank -> image helper
    function rankImage(rank) {
      const map = {
        "bronze": "./image/bronza.png",
        "silver": "./image/silver.png",
        "gold": "./image/gold.png",
        "smart gold": "./image/smart_gold.png",
        "platinium": "./image/platinium.png",
        "master": "./image/master.png"
      };
      return map[rank] || "./image/logo.png";
    }

    // UI rendering per tab (Game updated with taps logic)
    const content = document.getElementById('content');
    function renderGame() {
      const s = loadState();
      window.currentView = 'game';
      // update header balance immediately on render
      document.getElementById('headerBalance') && (document.getElementById('headerBalance').innerHTML = '<img src="./image/coin.png" alt="logo" style="width:25px; margin-right: 10px; vertical-align:middle;"> ' + fmtPRC(getTotalPRCWei(s)));
      if (typeof s.maxEnergy !== 'number') s.maxEnergy = DEFAULT_MAX_ENERGY;
      if (typeof s.energy !== 'number') s.energy = s.maxEnergy;

      const rank = getRankFromWei(s.prcWei);
      const defaultTapImg = rankImage(rank);
      const selectedSkin = s.selectedSkin;
      const skinObj = SKINS.find(x => x.id === selectedSkin);
      const displayImg = skinObj ? skinObj.file : defaultTapImg;

      // top quick access: Skin (left), Shop (center), Game (right) — diamond THEN previews THEN tap
      content.innerHTML = `
      <div class="tap-area">
        <div id="diamondTop" style="font-size:25px; margin-bottom:15px;">💎 ${s.diamond} </div>
        <!-- previews row: diamond above, previews here, then tap below -->
        <div id="previewsRow" style="display:flex; justify-content: space-between; align-items: center;">
          
          <div id="shopCardPreview" style="display: flex;  flex-direction: column; cursor:pointer; align-items: center;">
            <img src="./image/shop.png" alt="shop" style="width:52px; height:52px; object-fit:cover; margin-bottom: 10px; border-radius:8px;">
            <div style="flex:1; text-align:left;">
              <div style="font-weight:700;">Shop</div>
            </div>
          </div>
          <div id="gameCardPreview" style="display: flex;  flex-direction: column; cursor:pointer; align-items: center;">
            <img src="./image/game.png" alt="game" style="width:64px; height:64px; object-fit:cover; border-radius:8px;">
            <div style="flex:1; text-align:left;">
              <div style="font-weight:800; font-size:14px;">Play Games</div>
            </div>
          </div>
        </div>
        
        <img id="tapBtn" src="${displayImg}" alt="tap" draggable="false">
      </div>

      <div style="margin-top:14px;">
        <div class="row" style="display:flex; justify-content: space-between; gap:10px; align-items:center;">
          <div id="tapsBox" style="display:flex; align-items:center; gap:8px; background: rgba(0,0,0,0.35); border-radius:10px; padding:6px 12px;">
            ⚡️<span id="tapsCount">${s.energy} / ${s.maxEnergy}</span>
          </div>
          
        </div>
      </div>
     `;

      // tap handler: use energy (manual only) 
      const tapBtn = document.getElementById('tapBtn');
      tapBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        const state = loadState();
        if (state.energy <= 0) { alert('Energiya tugadi — kuting to‘ldirishni.'); return; }

        state.energy = Math.max(0, state.energy - 1);
        state.diamond += 1;
        saveState(state);

        document.getElementById('diamondTop').textContent = '💎 ' + state.diamond;
        document.getElementById('tapsCount').textContent = `${state.energy} / ${state.maxEnergy}`;
      });

      // quick open handlers (top-left previews) — skin preview now opens shop (skin tab inside shop)
      const skinPreview = document.getElementById('skinCardPreview');
      if (skinPreview) skinPreview.addEventListener('click', (ev) => { ev.stopPropagation(); renderShop(); });

      const shopPreview = document.getElementById('shopCardPreview');
      if (shopPreview) shopPreview.addEventListener('click', (ev) => { ev.stopPropagation(); renderShop(); });
      const gamePreview = document.getElementById('gameCardPreview');
      if (gamePreview) gamePreview.addEventListener('click', (ev) => { ev.stopPropagation(); renderGames(); });

      // energy auto-recharge (existing)
      if (window._energyInterval) { clearInterval(window._energyInterval); window._energyInterval = null; }
      window._energyInterval = setInterval(() => {
        const st = loadState();
        if (st.energy < st.maxEnergy) {
          st.energy = Math.min(st.maxEnergy, st.energy + 1);
          saveState(st);
          const el = document.getElementById('tapsCount');
          if (el) el.textContent = `${st.energy} / ${st.maxEnergy}`;
        } else {
          clearInterval(window._energyInterval); window._energyInterval = null;
        }
      }, 1000);

      // replace modal behavior: clicking boostsBox opens Boosts "page" (renderBoosts)
      const boostsBox = document.getElementById('boostsBox');
      if (boostsBox) {
        boostsBox.addEventListener('click', (ev) => { ev.stopPropagation(); renderBoosts(); });
      }

      // helpers to hide/show bottom nav
      function hideNav() { const nav = document.querySelector('.nav'); if (nav) nav.style.display = 'none'; }
      function showNav() { const nav = document.querySelector('.nav'); if (nav) nav.style.display = ''; }

      // --- NEW: renderBoosts shows dedicated Boosts page (like navigating to a tab) ---


      // --- NEW: renderShop (card layout) ---
      const SHOP_ITEMS = [
        { id: 'energyPack', name: 'Energy +1000', img: './image/boost.png', type: 'energy', amount: INCREASE_BLOCK, costWei: BigInt(INCREASE_BLOCK) * DIAMOND_TO_WEI },
        { id: 'tapPack', name: 'Taps +1000', img: './image/coin.png', type: 'taps', amount: INCREASE_BLOCK, costWei: BigInt(INCREASE_BLOCK) * DIAMOND_TO_WEI }
      ];
      function renderShop() {
        hideNav();
        const s = loadState();
        // header with back and internal tabs
        content.innerHTML = `
          <div style="display:flex; align-items:center; gap:8px; margin-bottom:12px;">
            <button id="backFromShop" class="btn">◀</button>
            <div class="btn-group">
              <div id="tabShop" class="btn">Shop</div>
              <div id="tabSkins" class="btn">Skins</div>
            </div>
          </div>
          <div style="display:flex; gap:12px; margin-top:6px;">
            <div id="shopCol" style="flex:1; display:flex; flex-direction:column; gap:12px;">
              ${SHOP_ITEMS.map(it => `
                <div class="shop-item" data-id="${it.id}" style=" margin-bottom: 20px; display: flex; background:rgba(0,0,0,0.5); border-radius:12px; padding:12px;">
                  <img src="${it.img}" alt="${it.name}" style="width:100px; object-fit:cover; border-radius:8px;">
                  <div style="margin-top:8px; display:flex; justify-content:space-between; align-items:center;">
                    <div><b>${it.name}</b><div style="color:#ccc; font-size:13px;">Cost: ${fmtPRC(it.costWei)}</div></div>
                    <button class="btn buyShopBtn" data-id="${it.id}">Buy</button>
                  </div>
                </div>
              `).join('')}
            </div>
            <div id="skinCol" style="flex:1; display:flex; flex-direction:column; gap:12px; display:none;">
              ${SKINS.map(sk => `
                <div class="skin-item" data-skin="${sk.id}" style="    margin-bottom: 20px; background:rgba(0,0,0,0.5); border-radius:12px; padding:12px;">
                  <img src="./image/${sk.id}" alt="${sk.name}" style="width:200px;  object-fit:cover; border-radius:8px;">
                  <div style="margin-top:8px; display:flex; justify-content:space-between; align-items:center;">
                    <div><b>${sk.name}</b><div style="color:#ccc; font-size:13px;">Skin for your tap</div></div>
                    <button class="btn buySkinBtn" data-skin="${sk.id}">Buy</button>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
        document.getElementById('backFromShop').addEventListener('click', () => { showNav(); renderGame(); });
        // tab handlers
        const tabShop = document.getElementById('tabShop');
        const tabSkins = document.getElementById('tabSkins');
        const shopCol = document.getElementById('shopCol');
        const skinCol = document.getElementById('skinCol');
        function activateShop() { shopCol.style.display = ''; skinCol.style.display = 'none'; tabShop.disabled = true; tabSkins.disabled = false; }
        function activateSkins() { shopCol.style.display = 'none'; skinCol.style.display = ''; tabShop.disabled = false; tabSkins.disabled = true; }
        tabShop.addEventListener('click', activateShop);
        tabSkins.addEventListener('click', activateSkins);
        // default active
        activateShop();
        // shop buys
        document.querySelectorAll('.buyShopBtn').forEach(btn => {
          btn.addEventListener('click', () => {
            const id = btn.dataset.id;
            const item = SHOP_ITEMS.find(x => x.id === id);
            if (!item) return;
            const state = loadState();
            if (!chargeCost(state, item.costWei)) { alert('Yetarli PRC yo‘q.'); return; }
            if (item.type === 'energy') state.maxEnergy = (state.maxEnergy || DEFAULT_MAX_ENERGY) + item.amount;
            else if (item.type === 'taps') state.tapCap = (state.tapCap || DEFAULT_TAP_CAP) + item.amount;
            saveState(state);
            alert(`${item.name} sotib olindi.`);
            renderShop();
          });
        });
        // skin buys (inside shop)
        document.querySelectorAll('.buySkinBtn').forEach(btn => {
          btn.addEventListener('click', () => {
            const skinId = btn.dataset.skin;
            const state = loadState();
            if (!chargeCost(state, SKIN_COST_WEI)) { alert('Yetarli PRC yo‘q skin sotib olish uchun.'); return; }
            state.selectedSkin = skinId;
            saveState(state);
            alert('Skin sotib olindi: ' + SKINS.find(s => s.id === skinId).name);
            renderShop();
          });
        });
      }

      // --- NEW: renderGames (list of game cards) ---
      const GAMES = [
        { id: 'game1', name: 'Game One', img: './game/game1.png' }
      ];
      function renderGames() {
        hideNav();
        const s = loadState();
        window.currentView = 'games';
        content.innerHTML = `
          <div style="display:flex; align-items:center; gap:8px; margin-bottom:12px;">
            <button id="backFromGames" style=" left:12px; top:12px; z-index:1200;">◀</button>
            <div style="flex:1; text-align:center; font-weight:800;">🎮 Games</div>
          </div>
          <div style="display:flex; justify-content:space-between; gap:12px; margin-top:6px;">
            <div style="flex:1; display:flex; flex-direction:column; gap:12px;">
              ${GAMES.map(g => `
                <div style="background:rgba(255,255,255,0.03); border-radius:12px; padding:12px; display:flex; flex-direction:column; justify-content:space-between; height:160px;">
                  <img src="${g.img}" alt="${g.name}" style="width:100%; height:90px; object-fit:cover; border-radius:8px;">
                  <div style="margin-top:8px; display:flex; justify-content:space-between; align-items:center;">
                    <div><b>${g.name}</b><div style="color:#ccc; font-size:13px;">Tap to play</div></div>
                    <button class="btn playGameBtn" data-id="${g.id}">Play</button>
                  </div>
                </div>
              `).join('')}
            </div>
            <div style="flex:1;"></div>
          </div>
        `;
        document.getElementById('backFromGames').addEventListener('click', () => { showNav(); renderGame(); });
        document.querySelectorAll('.playGameBtn').forEach(btn => {
          btn.addEventListener('click', () => {
            const id = btn.dataset.id;
            alert('Launching ' + id + ' (placeholder)');
            // future: integrate actual mini-game launch
          });
        });
      }
    } // end of function renderGame()

    // Loading helpers: controlled animation loop (blur <-> sharp) until content ready.
    (function () {
      let animInterval = null;
      let overlay = null;
      let img = null;
      let text = null;

      function startLoader() {
        overlay = overlay || document.getElementById('loadingOverlay');
        img = img || document.getElementById('loadingImg');
        text = text || document.getElementById('loadingText');
        if (!overlay) return;
        overlay.classList.remove('hidden');
        overlay.setAttribute('aria-hidden', 'false');
        // default: show image; if it errors we'll switch to text
        if (img) {
          img.style.display = '';
          text.style.display = 'none';
          img.classList.remove('sharp');
          // try to apply sharp/blurry loop
          let on = false;
          if (animInterval) clearInterval(animInterval);
          animInterval = setInterval(() => {
            if (!img) return;
            if (on) img.classList.add('sharp');
            else img.classList.remove('sharp');
            on = !on;
          }, 700);
        } else {
          // fallback: show text only
          if (text) { text.style.display = ''; }
        }
        // listen for image load/error: if error -> show text instead
        if (img) {
          img.addEventListener('error', onImgError);
          img.addEventListener('load', onImgLoad);
          // if image already loaded but failed to render (naturalWidth==0), treat as error
          if (img.complete && img.naturalWidth === 0) onImgError();
        }
      }
      function onImgError() {
        if (!img || !overlay) return;
        // hide image, show text
        img.style.display = 'none';
        const txt = document.getElementById('loadingText');
        if (txt) txt.style.display = '';
        // stop image animation if any
        if (animInterval) { clearInterval(animInterval); animInterval = null; }
      }
      function onImgLoad() {
        // ensure animation uses sharp state shortly after load
        if (img) {
          img.classList.add('sharp');
        }
      }
      function stopLoader() {
        overlay = overlay || document.getElementById('loadingOverlay');
        img = img || document.getElementById('loadingImg');
        text = text || document.getElementById('loadingText');
        if (!overlay) return;
        if (animInterval) { clearInterval(animInterval); animInterval = null; }
        // graceful fade: add hidden class after short delay so CSS transition applies
        overlay.classList.add('hidden');
        overlay.setAttribute('aria-hidden', 'true');
        // cleanup listeners
        if (img) {
          img.removeEventListener('error', onImgError);
          img.removeEventListener('load', onImgLoad);
        }
      }

      // expose to global for lifecycle usage
      window.startLoader = startLoader;
      window.stopLoader = stopLoader;
    })();

    // Helper: render UI then wait for content images to load (or timeout) before hiding loader
    function renderAndWait() {
      // render synchronously
      renderGame();
      // collect images inside content and wait for them
      const imgs = Array.from(document.getElementById('content').querySelectorAll('img'));
      const promises = imgs.map(im => {
        return new Promise(res => {
          if (im.complete) {
            // if it failed to load, naturalWidth==0 => consider as loaded to avoid stalling
            return res();
          }
          const ondone = () => { im.removeEventListener('load', ondone); im.removeEventListener('error', ondone); res(); };
          im.addEventListener('load', ondone);
          im.addEventListener('error', ondone);
        });
      });
      // wait all or timeout (2s)
      Promise.race([
        Promise.all(promises),
        new Promise(r => setTimeout(r, 2000))
      ]).then(() => {
        // give a small delay for final visual
        setTimeout(() => { window.stopLoader && window.stopLoader(); }, 120);
      });
    }

    // Tab switching (nav fixed at bottom visually)
    document.querySelectorAll('.nav .tab').forEach(el => {
      el.addEventListener('click', () => {
        document.querySelectorAll('.nav .tab').forEach(t => t.classList.remove('active'));
        el.classList.add('active');
        const tab = el.dataset.tab;
        if (tab === 'game') renderGame();
        if (tab === 'rank') renderRank();
        if (tab === 'wallet') renderWallet();
        if (tab === 'market') renderMarket();
        if (tab === 'earn') renderEarn();
      });
    });

    // default: start loader then render UI and stop loader after content settles
    window.startLoader && window.startLoader();
    // call renderAndWait to render and hide loader when ready
    setTimeout(renderAndWait, 250); // small delay so loader visuals start

    document.querySelectorAll('img').forEach(img => {
      img.addEventListener('contextmenu', e => e.preventDefault()); // O‘ng bosish menyusini o‘chiradi
    });
    document.addEventListener('contextmenu', event => event.preventDefault());
    document.addEventListener('selectstart', event => event.preventDefault());
    document.addEventListener('contextmenu', e => e.preventDefault());
    document.addEventListener('dragstart', e => e.preventDefault());
    document.addEventListener('touchstart', e => e.preventDefault());
  </script>

</body>

</html>