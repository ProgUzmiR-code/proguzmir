<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <script>
    (function () {
      const tg = window.Telegram.WebApp;
      try {
        // Ilovani tayyor deb belgilash
        tg.ready();

        // Darhol kengaytirish
        tg.expand();

        // Full screen so'rash
        if (tg.requestFullscreen) {
          tg.requestFullscreen();
        }

        // 3. Miltillashni oldini olish uchun fonni Loading rangi (qora) bilan bir xil qilamiz
        tg.setBackgroundColor("#000000");
        tg.setHeaderColor("#000000");

        // Ilova yuklangandan keyin oq rangga qaytarish uchun pastdagi mantiqqa kod qo'shish mumkin
      } catch (e) {
        console.error("Telegram init error:", e);
      }
    })();
  </script>

  <style>
    /* Loading overlay: shows only the image that sharpens over time */
    .loading-img {
      position: fixed;
      z-index: 10;
    }

    .loading-overlay {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgb(0, 0, 0);
      z-index: 10000;
      transition: opacity 300ms ease;
    }

    .loading-overlay.hidden {
      opacity: 0;
      pointer-events: none;
      visibility: hidden;
    }

    .loading-img {
      width: 70px;
      max-width: 70%;
      margin-top: 78px;
      opacity: 0.65;
      transition: filter 700ms ease, opacity 400ms ease, transform 700ms ease;
      transform: scale(1.02);
    }

    .loading-img.sharp {
      filter: blur(0);
      opacity: 1;
      transform: scale(1);
    }
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
  <script src="https://unpkg.com/tonweb@0.0.66/dist/tonweb.bundle.js"></script>

  <script type="module">
    import { createAppKit } from 'https://esm.sh/@reown/appkit@latest'
    import { EthersAdapter } from 'https://esm.sh/@reown/appkit-adapter-ethers@latest'
    import { mainnet, arbitrum, polygon, bsc } from 'https://esm.sh/@reown/appkit@latest/networks'
    window.AppKitLibrary = { createAppKit, EthersAdapter, networks: [mainnet, polygon, bsc] };
    console.log("AppKit Library (Networks moduli bilan) yuklandi!");
  </script>

  <script>
    // Loading helpers
    (function () {
      let animInterval = null;
      let overlay = null;
      let img = null;
      let text = null;

      function startLoader() {
        overlay = overlay || document.getElementById('loadingOverlay');
        img = img || document.getElementById('loadingImg');
        text = text || document.getElementById('loadingText');
        if (!overlay) return;
        overlay.classList.remove('hidden');
        overlay.setAttribute('aria-hidden', 'false');

        if (img) {
          img.style.display = '';
          text.style.display = 'none';
          img.classList.remove('sharp');
          let on = false;
          if (animInterval) clearInterval(animInterval);
          animInterval = setInterval(() => {
            if (!img) return;
            if (on) img.classList.add('sharp');
            else img.classList.remove('sharp');
            on = !on;
          }, 700);
        } else {
          if (text) { text.style.display = ''; }
        }
        if (img) {
          img.addEventListener('error', onImgError);
          img.addEventListener('load', onImgLoad);
          if (img.complete && img.naturalWidth === 0) onImgError();
        }
      }

      function onImgError() {
        if (!img || !overlay) return;
        img.style.display = 'none';
        const txt = document.getElementById('loadingText');
        if (txt) txt.style.display = '';
        if (animInterval) { clearInterval(animInterval); animInterval = null; }
      }

      function onImgLoad() {
        if (img) { img.classList.add('sharp'); }
      }

      function stopLoader() {
        // App to'liq yuklangach, fon rangini oqqa (yoki o'z dizayningizga) qaytarish
        if (window.Telegram && window.Telegram.WebApp) {
          window.Telegram.WebApp.setBackgroundColor("#ffffff");
        }

        overlay = overlay || document.getElementById('loadingOverlay');
        img = img || document.getElementById('loadingImg');
        text = text || document.getElementById('loadingText');
        if (!overlay) return;
        if (animInterval) { clearInterval(animInterval); animInterval = null; }
        overlay.classList.add('hidden');
        overlay.setAttribute('aria-hidden', 'true');
        if (img) {
          img.removeEventListener('error', onImgError);
          img.removeEventListener('load', onImgLoad);
        }
      }

      window.startLoader = startLoader;
      window.stopLoader = stopLoader;
    })();

    // Render helper
    function renderAndWait() {
      if (typeof renderGame === 'function') renderGame();
      const imgs = Array.from(document.getElementById('content')?.querySelectorAll('img') || []);
      const promises = imgs.map(im => {
        return new Promise(res => {
          if (im.complete) return res();
          const ondone = () => { im.removeEventListener('load', ondone); im.removeEventListener('error', ondone); res(); };
          im.addEventListener('load', ondone);
          im.addEventListener('error', ondone);
        });
      });
      Promise.race([
        Promise.all(promises),
        new Promise(r => setTimeout(r, 2000))
      ]).then(() => {
        setTimeout(() => { window.stopLoader && window.stopLoader(); }, 120);
      });
    }
  </script>

  <script>
    function getTelegramUser() {
      if (!window.Telegram?.WebApp?.initDataUnsafe?.user) return null;
      return Telegram.WebApp.initDataUnsafe.user;
    }
  </script>

  <script>
    (function () {
      try {
        if (window.Telegram && window.Telegram.WebApp) {
          // Bu yerda endi expand chaqirish shart emas, chunki tepadagi script allaqachon qildi.
          // Faqat username display logikasi qoladi.
          const u = window.Telegram.WebApp.initDataUnsafe?.user;
          if (u) {
            document.addEventListener('DOMContentLoaded', function () {
              const nameNode = document.querySelector('.profile .username');
              if (nameNode) {
                const display = ((u.first_name || '')).trim();
                nameNode.textContent = display || (u.username ? '@' + u.username : 'Telegram user');
              }
            });
          }
        }
      } catch (err) {
        console.warn('Telegram init skipped:', err);
      }
    })();
  </script>

  <link href="index.css" rel="stylesheet">
  <link rel="preload" href="./image/loading.svg" as="image">
  <link rel="shortcut icon" href="./image/loading.svg" type="image/svg/x-icon">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://unpkg.com/boxicons@2.0.7/css/boxicons.main.css" rel="stylesheet">

  <link href="earn/earn.css" rel="stylesheet">
  <link href="rank/rank.css" rel="stylesheet">
  <link href="friends/invite.css" rel="stylesheet">
  <link href="wallet/wallet.css" rel="stylesheet">
  <link href="key/key.css" rel="stylesheet">
  <link href="income/income.css" rel="stylesheet">

  <title>ProgUzmiR</title>
</head>

<body>
  <div id="loadingOverlay" class="loading-overlay" aria-hidden="false">
    <img id="loadingImg" class="loading-img" src="./image/loading.svg" alt="">
    <div id="loadingText" style="display:none;color:#fff;font-weight:700;">
      loading...
    </div>
  </div>

  <div class="header" aria-label="header">
    <div class="PRS font-effect-shadow-multiple">ProgUzmiR</div>
    <div class="circle2">
      <svg class="bg-shape" viewBox="0 0 505 75" preserveAspectRatio="none">
        <path d="M 0 0 L 505 0 L 505 88 C 505 70 504 60 481 60 L 24 60 C 1 60 0 70 0 88 L 0 0 Z" fill="#1f2f3a"></path>
      </svg>
      <div class="profile">
        <img style="margin-bottom: 10px; margin-left: 10px;" src="./image/loading.svg" alt="">
        <div class="username" style="font-size: 15px;">ProgUzmiR</div>
      </div>
      <div class="balance" id="headerBalance"><img src="./image/coin.png" alt="" style="width:25px;"> 0 PRC</div>
    </div>
  </div>

  <div class="panel" id="content">
    <div class="game" style="display: block;" id="gamecontent"></div>
    <div class="rank" style="display: none;" id="rankcontent"></div>
    <div class="wallet" style="display: none;" id="walletcontent"></div>
    <div class="invite" style="display: none;" id="invitecontent"></div>
    <div class="earn" style="display: none;" id="earncontent"></div>
    <div class="shop" style="display: none;" id="shopcontent"></div>
    <div class="daily" style="display: none;" id="dailycontent"></div>
    <div class="games" style="display: none;" id="gamelistcontent"></div>
    <div class="income" style="display: none;" id="incomecontent"></div>
    <div class="key" style="display: none;" id="keycontent"></div>
  </div>

  <div class="nav" role="tablist" aria-label="Navigation">
    <div class="circle1">
      <svg class="bg-shape" viewBox="0 0 505 75" preserveAspectRatio="none">
        <path d="M 0 0 L 505 0 L 505 88 C 505 70 504 60 480 60 L 350 60 C 275 60 275 50 252.5 50 C 230 50 230 60 155 60 L 25 60 C 1 60 0 70 0 88 L 0 0 Z" fill="#1f2f3a"></path>
      </svg>
    </div>
    <span class="nav-indicator"></span>
    <div class="li">
      <div class="tab" data-tab="game"><img class="i material-icons" src="./image/nav1.svg" alt=""><span
          id="r">GAME</span></div>
    </div>
    <div class="li">
      <div class="tab" data-tab="rank"><img class="i material-icons" src="./image/nav2.svg" alt=""><span
          id="r">RANK</span></div>
    </div>
    <div class="li">
      <div class="tab nav-item-active" data-tab="wallet"><img class="i svgicon" src="./image/coin.png" alt=""><span
          id="r">WALLET</span></div>
    </div>
    <div class="li">
      <div class="tab" data-tab="invite"><img class="i material-icons" src="./image/nav3.svg" alt=""><span
          id="r">INVITE</span></div>
    </div>
    <div class="li">
      <div class="tab earncolor" data-tab="earn"><img class="i material-icons fa-spin" src="./image/nav4.svg"
          alt=""><span id="r">EARN</span></div>
    </div>
  </div>

  <div id="paymentModal" class="payment-modal" style="display: none;">
    <div class="payment-content">
      <h3 id="paymentTitle">To'lov turini tanlang</h3>
      <p id="paymentItemName" style="color: #ffd700; margin-bottom: 20px;"></p>
      <div id="paymentOptions" class="payment-grid"></div>
      <button class="close-modal-btn" onclick="closePaymentModal()">Bekor qilish</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="index.js"></script>
  <script src="/render/game.js"></script>
  <script src="/render/shop.js"></script>
  <script src="/render/daily.js"></script>
  <script src="/wallet/ton.js"></script>
  <script src="/wallet/crypto.js"></script>
  <script src="/wallet/wallet.js"></script>
  <script src="/friends/friends.js"></script>

</body>
</html>