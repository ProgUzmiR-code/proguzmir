<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            background: #06121a;
            color: white;
            font-family: sans-serif;
            padding: 0;
            box-sizing: border-box;
        }

        .wallet {
            margin-top: 48px;
        }

        .wallet h1 {
            font-size: 24px;
            text-align: center;
            color: #ffd700;
        }

        header .flex {
            display: flex;
            align-items: center;
            gap: 2px;
            font-size: 25px;
        }

        .coins-center {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        ul {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            gap: 10px;
            padding: 0;
        }

        ul li {
            display: flex;
            flex-direction: column;
            cursor: pointer;
            align-items: center;
            padding: 5px 2px 5px 2px;
            list-style: none;
        }

        .invite-listm2,
        .invite-listm,
        .invitem {
            overflow-x: hidden;
        }

        .checked {
            color: #ffd700;
            border-bottom: 2px solid #ffffff;
        }

        .invite-listm3 {
            align-items: center;
            justify-content: center;
            height: 400px;
        }

        .invite-listm2 .ds {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .ds2 {
            margin-top: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .tab_mainm1 {
            display: flex;
        }

        .invite-listm2 .ds button {
            background-color: #ffd700;
            border: none;
            border-radius: 10px;
            height: 30px;
            width: 120px;
        }

        .Withdraw,
        .Recharge {
            text-align: center;
            background-color: #ffffff;
            color: black;
            border: none;
            border-radius: 0px 5px 5px 0px;
            height: 25px;
            width: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            overflow-x: hidden;
        }

        .Recharge {
            border-radius: 5px 0px 0px 5px;
        }

        .Active {
            background-color: #ffd700;
            color: black;
        }

        .q-mt-sm {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 300px;
        }

        .bton:active {
            color: white;

        }

        .invite-item {
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 7px;
            background: hsla(0, 0%, 0%, 0.5);
            display: -ms-flexbox;
            display: flex;
            -ms-flex-align: center;
            align-items: center;
        }

        .invite-icon {
            width: 50px;
            height: 50px;
            border-radius: 9px;
            background: hsla(0, 0%, 100%, .15);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .invite-info {
            flex: 1;
            margin-left: 10px;
            text-overflow: ellipsis;
            white-space: nowrap;
            overflow: hidden;
        }

        .invite-item .invite-arrow {
            display: flex;
            align-items: center;
        }

        .scoped-svg-icon {
            display: flex;
            align-items: center;
        }

        .invite-icon img {
            margin: auto;
            width: 100%;
            height: 100%;
        }

        /* Uzish tugmasi dizayni */
        .disconnect-btn {
            background: rgba(255, 77, 77, 0.2);
            /* Qizg'ish shaffof fon */
            color: #ff4d4d;
            /* Qizil yozuv */
            border: 1px solid #ff4d4d;
            padding: 6px 14px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            outline: none;
        }

        /* Bosilgandagi animatsiya (kichrayish) */
        .disconnect-btn:active {
            transform: scale(0.90);
            background: #ff4d4d;
            color: white;
        }

        /* Hover effekti (kompyuterda sichqoncha borganda) */
        .disconnect-btn:hover {
            background: rgba(255, 77, 77, 0.3);
        }
    </style>

    <style>
        /* Asosiy konteyner */
        #shopCol {
            display: block;
            padding: 10px;
        }

        /* Banner qismi */
        .promo-banner {
            background: linear-gradient(180deg, #4a90e2 0%, #1a56a0 100%);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            color: white;
            position: relative;
            overflow: hidden;
            height: 80px;
        }

        .promo-banner h2 {
            margin: 0;
            font-size: 22px;
            font-style: italic;
            position: relative;
            z-index: 50;
        }

        .promo-banner p {
            margin: 8px 0 0;
            font-size: 13px;
            opacity: 0.9;
            line-height: 1.4;
            position: relative;
            z-index: 50;
        }

        .promo-banner img {
            position: absolute;
            right: 0px;
            top: -10px;
            width: 100%;
            opacity: 0.8;
            z-index: 1;
        }

        /* Grid (Setka) qismi */
        .shop-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        /* Kartochka (Card) */
        .shop-card {
            background: #f3c178;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 2px solid #e2a04a;
            position: relative;
        }

        /* "First" bonus belgisi */
        .bonus-badge {
            position: absolute;
            top: 5px;
            left: 5px;
            background: #ff4d4d;
            color: white;
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 20px;
            border: 1px solid white;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 3px;
            z-index: 50;
        }

        .bonus-badge span {
            font-size: 8px;
        }

        /* Kartochka rasmi */
        .card-img {
            width: 100%;
            margin-top: 0px;
            margin-bottom: -60px;
            filter: drop-shadow(0 4px 4px rgba(0, 0, 0, 0.2));
            z-index: 1;
        }

        /* Kartochka nomi/qiymati */
        .card-title {
            font-weight: 900;
            color: #3a7994;
            font-size: 18px;
            margin-bottom: 5px;
            z-index: 50;
        }

        /* Sotib olish tugmasi */
        .buy-btn {
            background: #e69a30;
            width: 100%;
            text-align: center;
            padding: 8px 0;
            color: white;
            font-weight: bold;
            border-top: 2px solid #d48a20;
            cursor: pointer;
            z-index: 50;
            transition: background 0.2s;
        }

        .buy-btn:active {
            background: #d48a20;
        }
    </style>

    <title>Document</title>
</head>

<body>
    <header>
        <div class="wallet">
            <h1>Wallet Page</h1>
        </div>
        <div class="coins-center">
            <div class="flex">
                üíé<span id="diamondCount">0</span>
            </div>
        </div>
    </header>
    <div class="invitem">
        <div class="tab_mainm">
            <ul>
                <li class="tab_itemm " data-target="completed">Withdraw</li>
                <li class="tab_itemm " data-target="inactive">Recharge</li>
                <li class="tab_itemm checked" data-target="active">Records</li>
            </ul>
        </div>

        <div class="invite-listm" style="display: none;">
            <div id="shopCol">

                <div class="promo-banner">
                    <h2>2X Gem Bonus</h2>
                    <p>
                        Any first purchase of any <br> tier earns 2x Rebate rewards.
                    </p>
                    <img src="./image/gems_pile.jpg" alt="diamond">
                </div>

                <div class="shop-grid">

                    <div class="shop-card">
                        <div class="bonus-badge">
                            <span>First</span> üíé +500
                        </div>
                        <img src="./image/bagdiamonds.jpg" class="card-img">
                        <div class="card-title">500</div>
                        <div class="buy-btn" onclick="buyItem('gem1')">1,19 US$</div>
                    </div>

                    <div class="shop-card">
                        <div class="bonus-badge">
                            <span>First</span> üíé +2,500
                        </div>
                        <img src="./image/gem1.jpg" class="card-img">
                        <div class="card-title">2,500</div>
                        <div class="buy-btn" onclick="buyItem('gem2')">5,99 US$</div>
                    </div>

                    <div class="shop-card">
                        <div class="bonus-badge">
                            <span>First</span> üíé +5,000
                        </div>
                        <img src="./image/gem2.jpg" class="card-img">
                        <div class="card-title">5,000</div>
                        <div class="buy-btn" onclick="buyItem('gem3')">11,99 US$</div>
                    </div>

                    <div class="shop-card">
                        <div class="bonus-badge">
                            <span>First</span> üíé +10,000
                        </div>
                        <img src="./image/gem3.jpg" class="card-img">
                        <div class="card-title">10,000</div>
                        <div class="buy-btn" onclick="buyItem('gem4')">23,99 US$</div>
                    </div>

                    <div class="shop-card">
                        <div class="bonus-badge">
                            <span>First</span> üíé +25,000
                        </div>
                        <img src="./image/gem4.jpg" class="card-img">
                        <div class="card-title">25,000</div>
                        <div class="buy-btn" onclick="buyItem('gem5')">54,99 US$</div>
                    </div>

                    <div class="shop-card">
                        <div class="bonus-badge">
                            <span>First</span> üíé +50,000
                        </div>
                        <img src="./image/gem5.jpg" class="card-img">
                        <div class="card-title">50,000</div>
                        <div class="buy-btn" onclick="buyItem('gem6')">109,99 US$</div>
                    </div>

                </div>
            </div>

        </div>






        <div class="der">
            <div class="invite-listm2" style="display: block;">
                <div id="btnTon" class="invite-item bton">
                    <div class="invite-icon">
                        <img src="https://cryptologos.cc/logos/toncoin-ton-logo.svg?v=040" alt="">
                    </div>
                    <div class="invite-info">
                        <span>Your TON address connected</span>
                    </div>
                    <div class="invite-arrow">
                        <span data-v-df5a9ee0="" aria-hidden="true" class="scoped-svg-icon ">
                            <img src="/image/arrow.svg" alt="">
                        </span>
                    </div>
                </div>
                <div id="btnMetaMask" class="invite-item bton">
                    <div class="invite-icon">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/3/36/MetaMask_Fox.svg" alt="">
                    </div>
                    <div class="invite-info">
                        <span>Your MetaMask address connected</span>
                    </div>
                    <div class="invite-arrow">
                        <span data-v-df5a9ee0="" aria-hidden="true" class="scoped-svg-icon ">
                            <img src="/image/arrow.svg" alt="">
                        </span>
                    </div>
                </div>
                <div>
                    <div class="ds2">
                        <span>Recharge Record</span>
                        <div class="tab_mainm1 w1">
                            <div class="Recharge tab_itemm1 w2 Active" data-target="recharge" style="font-size: 14px;">
                                Recharge</div>
                            <div class="Withdraw tab_itemm1 w2" data-target="withdraw" style="font-size: 14px;">Withdraw
                            </div>
                        </div>

                    </div>
                    <div class="invite-listm4">
                        <span class="q-mt-sm">No transaction records</span>
                    </div>
                    <div class="invite-listm5" style="display: none;">
                        <span class="q-mt-sm">No transaction records</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="invite-listm3" style="display: none;">
            <span>Withdraw soon</span>
        </div>
    </div>

    </div>

    <script>
        // Hamyon manzillari (Boshida bo'sh turadi)
        let MERCHANT_TON = null;
        let MERCHANT_EVM = null;

        // Sahifa yuklanishi bilan Vercel API dan manzillarni olib kelamiz
        async function loadWalletConfig() {
            try {
                const response = await fetch('/api/wallet-data.js');
                const data = await response.json();

                if (data.ton_address && data.evm_address) {
                    MERCHANT_TON = data.ton_address;
                    MERCHANT_EVM = data.evm_address;
                    console.log("Hamyon manzillari serverdan yuklandi ‚úÖ");
                } else {
                    console.error("Serverdan manzillar kelmadi ‚ùå");
                }
            } catch (error) {
                console.error("Konfiguratsiyani yuklashda xatolik:", error);
            }
        }

        // Konfiguratsiyani ishga tushiramiz
        loadWalletConfig();

        // Mahsulot narxlari (Bular o'zgarmas qolaveradi)
        const PRICES = {
            'gem1': { name: "500 diamond", ton: '200000000', eth: '0.0004' },
            'gem2': { name: "2,500 diamond", ton: '1000000000', eth: '0.002' },
            'gem3': { name: "5,000 diamond", ton: '2000000000', eth: '0.004' },
            'gem4': { name: "10,000 diamond", ton: '4000000000', eth: '0.008' },
            'gem5': { name: "25,000 diamond", ton: '10000000000', eth: '0.018' },
            'gem6': { name: "50,000 diamond", ton: '20000000000', eth: '0.036' }
        };

        // --- 2. ASOSIY SOTIB OLISH FUNKSIYASI ---
        async function buyItem(itemId) {
            console.log("Tanlangan mahsulot: " + itemId);

            // 0. Manzillar yuklanganini tekshirish (MUHIM)
            if (!MERCHANT_TON || !MERCHANT_EVM) {
                alert("Tizim ma'lumotlari yuklanmoqda... Iltimos, 2 soniya kutib qayta bosing.");
                // Agar yuklanmagan bo'lsa, qayta urinib ko'ramiz
                loadWalletConfig();
                return;
            }

            // 1. Mahsulot bazada borligini tekshiramiz
            const item = PRICES[itemId];
            if (!item) {
                alert("Xatolik: Bunday mahsulot topilmadi!");
                return;
            }

            // 2. Qaysi hamyon ulanganini aniqlaymiz
            const walletType = localStorage.getItem("proguzmir_wallet_type");

            if (walletType === 'ton') {
                if (confirm(`${item.name} ni TON orqali sotib olasizmi?`)) {
                    await payWithTon(item.ton);
                }
            } else if (walletType === 'evm') {
                if (confirm(`${item.name} ni MetaMask (BNB/ETH) orqali sotib olasizmi?`)) {
                    await payWithEvm(item.eth);
                }
            } else {
                alert("Sotib olish uchun avval hamyonni (TON yoki MetaMask) ulang!");
                document.querySelector('.invite-listm2').scrollIntoView({ behavior: 'smooth' });
            }
        }

        // --- 3. TON TO'LOV FUNKSIYASI ---
        async function payWithTon(amountNano) {
            if (!window.tonConnectUI || !window.tonConnectUI.connected) {
                alert("TON hamyon ulanmagan yoki uzilib qolgan!");
                return;
            }

            const transaction = {
                validUntil: Math.floor(Date.now() / 1000) + 600,
                messages: [
                    {
                        address: MERCHANT_TON, // Endi bu yerda serverdan kelgan manzil bo'ladi
                        amount: amountNano
                    }
                ]
            };

            try {
                const result = await window.tonConnectUI.sendTransaction(transaction);
                console.log("TON To'lov muvaffaqiyatli:", result);
                alert("To'lov qabul qilindi! Hisobingiz tez orada to'ldiriladi.");
            } catch (e) {
                console.error(e);
                alert("To'lov bekor qilindi.");
            }
        }

        // --- 4. EVM (METAMASK) TO'LOV FUNKSIYASI ---
        async function payWithEvm(amountEth, itemName) {

            // 1. Agar MetaMask tizimi umuman yuklanmagan bo'lsa
            if (!window.evmModal) {
                console.log("MetaMask tizimi topilmadi. Qayta ishga tushirilmoqda...");

                if (window.initMetaMaskWallet) {
                    try {
                        await window.initMetaMaskWallet();
                    } catch (e) {
                        console.error("Init Error:", e);
                    }
                }

                // Ikkinchi marta tekshiramiz
                if (!window.evmModal) {
                    alert("Tizim hali yuklanmadi. Iltimos, sahifani yangilab (Reload) qayta urinib ko'ring.");
                    return;
                }
            }

            // 2. Ulanish holatini tekshirish (YANGI USUL)
            // getIsConnected() o'rniga getAccount().isConnected ishlatamiz
            let isConnected = false;
            try {
                const account = window.evmModal.getAccount();
                isConnected = account.isConnected;
            } catch (e) {
                console.warn("Account holatini olishda xatolik:", e);
            }

            if (!isConnected) {
                console.log("Sessiya uzilgan. Qayta ulanish so'ralmoqda...");
                await window.evmModal.open(); // Ulanish oynasini ochamiz
                return;
            }

            // 3. To'lov jarayoni
            try {
                const provider = window.evmModal.getProvider();
                const account = window.evmModal.getAccount();
                const myAddress = account.address; // Manzilni to'g'ri joydan olamiz

                if (!myAddress) {
                    alert("Hamyon manzili aniqlanmadi. Qayta ulaning.");
                    return;
                }

                // Matematik hisob (xavfsiz)
                const weiValue = BigInt(Math.round(parseFloat(amountEth) * 1e18)).toString(16);

                const txParams = {
                    from: myAddress,
                    to: MERCHANT_EVM,
                    value: "0x" + weiValue,
                };

                const txHash = await provider.request({
                    method: 'eth_sendTransaction',
                    params: [txParams],
                });

                console.log("Tranzaksiya yuborildi. Hash:", txHash);
                showNotification(`${itemName} to'lovi yuborildi! Hash: ${txHash}`, 'success');

            } catch (e) {
                console.error(e);
                showNotification("Xatolik: " + (e.message || "Bekor qilindi"), 'error');
            }
        }


    </script>



    <script>
        // Bu yerda endi HTML render qilinmaydi.
        // Faqat tugma bosilganda ishlaydigan funksiyalar turadi.

        const SHOP = [
            { id: 'energyPack', name: 'Energy +1000', img: './image/boost.png', type: 'energy', amount: 1000 }
        ];

        // Tugma bosilganda ishlaydigan funksiya
        function buyItem(itemId) {
            console.log("Sotib olishga bosildi: " + itemId);
            // Bu yerda to'lov logikasi bo'ladi
        }
    </script>



    <script>
        // Update diamond display
        function updateDiamondDisplay() {
            const diamondCount = document.getElementById('diamondCount');
            if (diamondCount) {
                try {
                    // Load state from localStorage (same as index.js)
                    const KEY_DIAMOND = "proguzmir_diamond";
                    const KEY_WALLET = "proguzmir_wallet";

                    function makeUserKey(baseKey, wallet) {
                        return wallet ? baseKey + "_" + wallet.toLowerCase() : baseKey + "_guest";
                    }

                    const wallet = localStorage.getItem(KEY_WALLET) || "";
                    const keyDiamond = makeUserKey(KEY_DIAMOND, wallet);
                    const diamond = parseInt(localStorage.getItem(keyDiamond) || "0", 10);

                    diamondCount.textContent = diamond;
                } catch (e) {
                    console.log("Diamond load error:", e);
                }
            }
        }

        // Update on page load
        updateDiamondDisplay();

        // Update every second to catch changes
        setInterval(updateDiamondDisplay, 1000);
    </script>
    <script>
        document.addEventListener('click', function (e) {

            const tab = e.target.closest('.tab_itemm, .tab_itemm1, .w2');
            if (!tab) return;

            const status = tab.dataset.target?.toLowerCase();
            if (!status) return;

            /* ===== TAB MAIN M (1-sistema) ===== */
            if (tab.closest('.tab_mainm')) {

                document
                    .querySelectorAll('.tab_mainm .tab_itemm, .tab_mainm .tab_itemm1')
                    .forEach(t => t.classList.remove('checked'));

                tab.classList.add('checked');

                document.querySelectorAll('.invitem').forEach(inviteBlock => {

                    const lists = {
                        inactive: inviteBlock.querySelector('.invite-listm'),
                        active: inviteBlock.querySelector('.invite-listm2'),
                        completed: inviteBlock.querySelector('.invite-listm3'),
                    };

                    Object.values(lists).forEach(l => l && (l.style.display = 'none'));

                    if (lists[status]) {
                        lists[status].style.display =
                            status === 'completed' ? 'flex' : 'block';
                    }
                });

                return; // ‚ùó BU YERDA TO‚ÄòXTAYDI
            }

            /* ===== W1 / DER (2-sistema) ===== */
            if (tab.closest('.der')) {

                document
                    .querySelectorAll('.der .w2')
                    .forEach(t => t.classList.remove('Active'));

                tab.classList.add('Active');

                document.querySelectorAll('.der').forEach(derBlock => {

                    const lists = {
                        recharge: derBlock.querySelector('.invite-listm4'),
                        withdraw: derBlock.querySelector('.invite-listm5'),
                    };

                    Object.values(lists).forEach(l => l && (l.style.display = 'none'));

                    if (lists[status]) {
                        lists[status].style.display = 'block';
                    }
                });

                return; // ‚ùó BOSHQA BLOKLARGA O‚ÄòTMAYDI
            }
        });
    </script>
    <script>
        // show Telegram BackButton and set it to return to main renderGame
        showTelegramBack(() => { showheader(); renderGame(); });
        // hide bottom nav and enable Telegram Back to return to game
        hideheader();
        showTelegramBack(() => { hideTelegramBack(); showheader(); renderGame(); });
        // back handler
        document.getElementById('keyBack').addEventListener('click', () => { hideTelegramBack(); showNav(); renderGame(); });
        // helpers to hide/show bottom header
        function hideheader() { const nav = document.querySelector('.header'); if (nav) nav.style.display = 'none'; }
        function showheader() { const nav = document.querySelector('.header'); if (nav) nav.style.display = ''; }
    </script>
</body>

</html>