<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Shop — ProgUzmiR</title>
  <link rel="stylesheet" href="./index.css">
  <style>
    /* small local overrides */
    body {
      background: #06121a;
      color: #fff;
      font-family: sans-serif;
      padding: 20px;
    }

    .shop-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 18px;
    }

    .shop-header .title {
      font-weight: 800;
      font-size: 20px;
      flex: 1;
      text-align: center;
    }

    .shop-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .shop-item {
      display: flex;
      gap: 12px;
      align-items: center;
      background: rgba(0, 0, 0, 0.5);
      padding: 12px;
      border-radius: 10px;
    }

    .shop-item img {
      width: 84px;
      height: 84px;
      object-fit: cover;
      border-radius: 8px;
    }

    .shop-item .info {
      flex: 1;
    }

    .btn {
      background: rgba(8, 96, 211, 0.2);
      color: #fff;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      border: 0;
    }
  </style>
</head>

<body>
  <div class="shop-header">
    <button id="backBtn" class="btn">◀ Back</button>
    <div class="title">Shop</div>
    <div id="balance" style="min-width:180px; text-align:right;">--</div>
  </div>

  <div id="shopList" class="shop-list"></div>

  <script>
    // Minimal helpers (match index.html keys/logic)
    const DIAMOND_TO_WEI = 1n;
    const KEY_PRC = "proguzmir_prc_wei";
    const KEY_DIAMOND = "proguzmir_diamond";
    const KEY_WALLET = "proguzmir_wallet";
    const KEY_SELECTED_SKIN = "proguzmir_selected_skin";
    const KEY_ENERGY = "proguzmir_energy";
    const KEY_MAX_ENERGY = "proguzmir_max_energy";
    const DEFAULT_MAX_ENERGY = 1000;
    const SKIN_COST_WEI = 500000000000000n;
    const INCREASE_BLOCK = 1000;
    const DECIMALS = 18n;
    const UNIT = 10n ** DECIMALS;

    const SKINS = [
      { id: "bronza.png", name: "Bronza", file: "./image/bronza.png" },
      { id: "silver.png", name: "Silver", file: "./image/silver.png" },
      { id: "gold.png", name: "Gold", file: "./image/gold.png" },
      { id: "smart_gold.png", name: "Smart Gold", file: "./image/smart_gold.png" },
      { id: "platinium.png", name: "Platinium", file: "./image/platinium.png" },
      { id: "master.png", name: "Master", file: "./image/master.png" }
    ];

    const SHOP_ITEMS = [
      { id: 'energyPack', name: 'Energy +1000', img: './image/boost.png', type: 'energy', amount: INCREASE_BLOCK, costWei: BigInt(INCREASE_BLOCK) * DIAMOND_TO_WEI },
      { id: 'tapPack', name: 'Taps +1000', img: './image/coin.png', type: 'taps', amount: INCREASE_BLOCK, costWei: BigInt(INCREASE_BLOCK) * DIAMOND_TO_WEI }
    ];

    function makeUserKey(baseKey, wallet) { return wallet ? baseKey + "_" + wallet.toLowerCase() : baseKey + "_guest"; }
    function loadState() {
      const wallet = localStorage.getItem(KEY_WALLET) || "";
      const prc = localStorage.getItem(makeUserKey(KEY_PRC, wallet)) || "0";
      const diamond = parseInt(localStorage.getItem(makeUserKey(KEY_DIAMOND, wallet)) || "0", 10);
      const selectedSkin = localStorage.getItem(makeUserKey(KEY_SELECTED_SKIN, wallet)) || "";
      const maxEnergy = parseInt(localStorage.getItem(makeUserKey(KEY_MAX_ENERGY, wallet)) || String(DEFAULT_MAX_ENERGY), 10);
      let energy = parseInt(localStorage.getItem(makeUserKey(KEY_ENERGY, wallet)) || String(maxEnergy), 10);
      if (Number.isNaN(energy)) energy = maxEnergy;
      if (energy > maxEnergy) energy = maxEnergy;
      return { prcWei: BigInt(prc), diamond, wallet, selectedSkin, energy, maxEnergy };
    }
    function getTotalPRCWei(state) { return state.prcWei + BigInt(state.diamond) * DIAMOND_TO_WEI; }
    function saveState(state) {
      const wallet = state.wallet || localStorage.getItem(KEY_WALLET) || "";
      localStorage.setItem(makeUserKey(KEY_PRC, wallet), state.prcWei.toString());
      localStorage.setItem(makeUserKey(KEY_DIAMOND, wallet), String(state.diamond));
      localStorage.setItem(makeUserKey(KEY_ENERGY, wallet), String(state.energy || 0));
      localStorage.setItem(makeUserKey(KEY_MAX_ENERGY, wallet), String(state.maxEnergy || DEFAULT_MAX_ENERGY));
      if (state.selectedSkin) localStorage.setItem(makeUserKey(KEY_SELECTED_SKIN, wallet), state.selectedSkin);
      else localStorage.removeItem(makeUserKey(KEY_SELECTED_SKIN, wallet));
      // update balance text
      const bal = document.getElementById('balance');
      if (bal) bal.textContent = fmtPRC(getTotalPRCWei(state));
    }
    function chargeCost(state, costWei) {
      const total = getTotalPRCWei(state);
      if (total < costWei) return false;
      if (state.prcWei >= costWei) { state.prcWei -= costWei; saveState(state); return true; }
      let remaining = costWei - state.prcWei;
      state.prcWei = 0n;
      const diamondsNeeded = Number((remaining + DIAMOND_TO_WEI - 1n) / DIAMOND_TO_WEI);
      state.diamond = Math.max(0, state.diamond - diamondsNeeded);
      const paidByDiamondsWei = BigInt(diamondsNeeded) * DIAMOND_TO_WEI;
      const overpay = paidByDiamondsWei - remaining;
      if (overpay > 0n) state.prcWei += overpay;
      saveState(state);
      return true;
    }
    function fmtPRC(wei) {
      const negative = wei < 0n;
      if (negative) wei = -wei;
      const whole = (wei / UNIT).toString();
      let frac = (wei % UNIT).toString().padStart(Number(DECIMALS), '0');
      // trim trailing zeros
      let lastNonZero = frac.length - 1;
      while (lastNonZero >= 0 && frac[lastNonZero] === '0') lastNonZero--;
      if (lastNonZero < 0) return (negative ? '-' : '') + whole + '.0 PRC';
      frac = frac.slice(0, lastNonZero + 1);
      // compress runs >=3
      let out = '';
      for (let i = 0; i < frac.length;) {
        const ch = frac[i]; let j = i + 1; while (j < frac.length && frac[j] === ch) j++;
        const len = j - i;
        out += (len >= 3) ? (ch + '{' + len + '}') : ch.repeat(len);
        i = j;
      }
      return (negative ? '-' : '') + whole + '.' + out + ' PRC';
    }

    // render shop
    function renderShop() {
      const state = loadState();
      document.getElementById('balance').textContent = fmtPRC(getTotalPRCWei(state));
      const list = document.getElementById('shopList');
      list.innerHTML = '';
      SHOP_ITEMS.forEach(it => {
        const div = document.createElement('div');
        div.className = 'shop-item';
        div.innerHTML = `<img src="${it.img}" alt="${it.name}"><div class="info"><b>${it.name}</b><div style="color:#ccc;font-size:13px;">Cost: ${fmtPRC(it.costWei)}</div></div><div><button class="btn buy" data-id="${it.id}">Buy</button></div>`;
        list.appendChild(div);
      });
      // skins column
      SKINS.forEach(sk => {
        const div = document.createElement('div');
        div.className = 'shop-item';
        div.innerHTML = `<img src="${sk.file}" alt="${sk.name}"><div class="info"><b>${sk.name}</b><div style="color:#ccc;font-size:13px;">Skin for your tap</div></div><div><button class="btn buy-skin" data-skin="${sk.id}">Buy</button></div>`;
        list.appendChild(div);
      });
      // attach handlers
      list.querySelectorAll('.buy').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = btn.dataset.id;
          const item = SHOP_ITEMS.find(x => x.id === id);
          const st = loadState();
          if (!chargeCost(st, item.costWei)) { alert('Yetarli PRC yo‘q.'); return; }
          if (item.type === 'energy') st.maxEnergy = (st.maxEnergy || DEFAULT_MAX_ENERGY) + item.amount;
          else if (item.type === 'taps') {
            // store taps cap in same key format as index if needed
            const key = makeUserKey('proguzmir_tap_cap', st.wallet);
            const cur = parseInt(localStorage.getItem(key) || String(DEFAULT_TAP_CAP), 10);
            localStorage.setItem(key, String(cur + item.amount));
          }
          saveState(st);
          alert(item.name + ' sotib olindi.');
          renderShop();
        });
      });
      list.querySelectorAll('.buy-skin').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const skinId = btn.dataset.skin;
          const st = loadState();
          if (!chargeCost(st, SKIN_COST_WEI)) { alert('Yetarli PRC yo‘q skin sotib olish uchun.'); return; }
          st.selectedSkin = skinId;
          saveState(st);
          alert('Skin sotib olindi: ' + (SKINS.find(s => s.id === skinId) || {}).name);
          renderShop();
        });
      });
    }

    document.getElementById('backBtn').addEventListener('click', () => { window.location.href = './index.html'; });

    document.addEventListener('DOMContentLoaded', renderShop);
  </script>
</body>

</html>